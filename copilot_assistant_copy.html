<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ–‡ä»¶è™•ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* é é¢æ¨™é¡Œ */
        .page-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .steps-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: white;
            color: #667eea;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #4caf50;
            color: white;
        }

        .step-label {
            color: white;
            font-size: 14px;
            opacity: 0.7;
        }

        .step.active .step-label {
            opacity: 1;
            font-weight: 600;
        }

        .step-arrow {
            color: white;
            opacity: 0.5;
            font-size: 20px;
        }

        /* ä¸»è¦å…§å®¹å¡ç‰‡ */
        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            min-height: 500px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ + ä¸Šå‚³ ===== */
        .layer-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
        }

        .type-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 700px;
            margin: 0 auto 40px;
        }

        .type-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .type-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .type-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .type-card h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .type-card p {
            font-size: 13px;
            opacity: 0.8;
        }

        .format-tags {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .format-tag {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 500;
        }

        .type-card.selected .format-tag {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ä¸Šå‚³å€åŸŸ */
        .upload-section {
            max-width: 700px;
            margin: 0 auto;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        .upload-zone {
            border: 3px dashed #d0d0d0;
            border-radius: 16px;
            padding: 50px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f5f6ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e8eaff;
            transform: scale(1.02);
        }

        .upload-zone.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }

        .upload-zone h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-zone p {
            color: #666;
            font-size: 14px;
        }

        .file-info {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-info .icon {
            font-size: 40px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .file-size {
            font-size: 13px;
            color: #666;
        }

        .remove-file-btn {
            background: #ff5252;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .remove-file-btn:hover {
            background: #ff1744;
        }

        /* ===== ç¬¬äºŒå±¤ï¼šOCR çµæœ ===== */
        .ocr-result-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .result-header {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .result-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-header .icon {
            font-size: 40px;
        }

        .result-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .result-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .confidence-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .ocr-data-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .data-label {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .data-value {
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .warning-box .icon {
            font-size: 24px;
        }

        .warning-box p {
            color: #856404;
            font-size: 14px;
            margin: 0;
        }

        /* ===== ç¬¬ä¸‰å±¤ï¼šæ ¼å¼é¸æ“‡ ===== */
        .format-selection-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .selected-data-summary {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .selected-data-summary h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .format-selection-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .format-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .format-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .format-option .icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .format-option h4 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .format-option p {
            font-size: 13px;
            opacity: 0.8;
        }

        /* æŒ‰éˆ• */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* è™•ç†ä¸­å‹•ç•« */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }

        .processing-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 6px solid #f0f0f0;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .processing-detail {
            font-size: 14px;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .type-selection {
                grid-template-columns: 1fr;
            }

            .data-grid, .summary-grid {
                grid-template-columns: 1fr;
            }

            .format-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
            <h1>ğŸ¤– æ™ºæ…§æ–‡ä»¶è™•ç†ç³»çµ±</h1>
            <p>Powered by Copilot Studio & Azure OpenAI</p>
        </div>

        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="steps-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">é¸æ“‡é¡å‹ä¸¦ä¸Šå‚³</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">ç¢ºèª OCR çµæœ</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">é¸æ“‡åŒ¯å‡ºæ ¼å¼</div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å¡ç‰‡ -->
        <div class="main-card">
            <!-- ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ + ä¸Šå‚³ ===== -->
            <div id="layer1">
                <h2 class="layer-title">é¸æ“‡æ–‡ä»¶é¡å‹ä¸¦ä¸Šå‚³</h2>
                
                <div class="type-selection">
                    <div class="type-card" id="invoiceCard" onclick="selectType('invoice')">
                        <div class="type-icon">ğŸ“„</div>
                        <h3>ç™¼ç¥¨</h3>
                        <p>è‡ªå‹•è¾¨è­˜ç™¼ç¥¨å…§å®¹</p>
                        <div class="format-tags">
                            <span class="format-tag">406INF.xlsx</span>
                            <span class="format-tag">407INF.csv</span>
                        </div>
                    </div>

                    <div class="type-card" id="orderCard" onclick="selectType('order')">
                        <div class="type-icon">ğŸ›’</div>
                        <h3>è¨‚å–®</h3>
                        <p>è­˜åˆ¥è¨‚å–®è³‡è¨Š</p>
                        <div class="format-tags">
                            <span class="format-tag">CO.csv</span>
                            <span class="format-tag">SO.csv</span>
                            <span class="format-tag">å…©éšæ®µ.csv</span>
                        </div>
                    </div>
                </div>

                <div class="upload-section" id="uploadSection">
                    <div id="uploadArea">
                        <div class="upload-zone disabled" id="uploadZone">
                            <div class="upload-icon">ğŸ“</div>
                            <h3>è«‹å…ˆé¸æ“‡æ–‡ä»¶é¡å‹</h3>
                            <p>é¸æ“‡ä¸Šæ–¹çš„ç™¼ç¥¨æˆ–è¨‚å–®å¾Œå³å¯ä¸Šå‚³</p>
                        </div>
                    </div>

                    <div id="fileInfoArea" class="hidden">
                        <div class="file-info">
                            <div class="icon">ğŸ“„</div>
                            <div class="file-details">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                            </div>
                            <button class="remove-file-btn" onclick="removeFile()">ç§»é™¤</button>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="resetToStart()">é‡æ–°é¸æ“‡</button>
                            <button class="btn btn-primary" onclick="startOCR()">é–‹å§‹è¾¨è­˜</button>
                        </div>
                    </div>
                </div>

                <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload(event)">
            </div>

            <!-- ===== ç¬¬äºŒå±¤ï¼šOCR çµæœ ===== -->
            <div id="layer2" class="hidden">
                <div class="ocr-result-section">
                    <div class="result-header">
                        <div class="result-header-left">
                            <div class="icon">âœ…</div>
                            <div>
                                <h3>OCR è¾¨è­˜å®Œæˆ</h3>
                                <p>æ–‡ä»¶å·²æˆåŠŸè¾¨è­˜ä¸¦çµæ§‹åŒ–</p>
                            </div>
                        </div>
                        <div class="confidence-badge" id="confidenceBadge">
                            ä¿¡è³´åº¦: 95%
                        </div>
                    </div>

                    <div class="warning-box">
                        <div class="icon">ğŸ’¡</div>
                        <p>è«‹ä»”ç´°æª¢æŸ¥è¾¨è­˜çµæœï¼Œå¦‚æœè³‡æ–™æœ‰èª¤ï¼Œå¯ä»¥é»æ“Šã€Œé‡æ–°è¾¨è­˜ã€</p>
                    </div>

                    <div class="ocr-data-card">
                        <div class="data-grid" id="ocrDataGrid">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="resetToStart()">å–æ¶ˆ</button>
                        <button class="btn btn-warning" onclick="retryOCR()">ğŸ”„ é‡æ–°è¾¨è­˜</button>
                        <button class="btn btn-success" onclick="confirmOCR()">âœ“ ç¢ºèªä¸¦ç¹¼çºŒ</button>
                    </div>
                </div>
            </div>

            <!-- ===== ç¬¬ä¸‰å±¤ï¼šé¸æ“‡åŒ¯å‡ºæ ¼å¼ ===== -->
            <div id="layer3" class="hidden">
                <div class="format-selection-section">
                    <div class="selected-data-summary">
                        <h4>
                            <span>ğŸ“‹</span>
                            <span>å·²è¾¨è­˜è³‡æ–™æ‘˜è¦</span>
                        </h4>
                        <div class="summary-grid" id="summaryGrid">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <h3 class="format-selection-title">ğŸ“¦ è«‹é¸æ“‡åŒ¯å‡ºæ ¼å¼</h3>
                    
                    <div class="format-options" id="formatOptions">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="backToOCR()">è¿”å›æª¢è¦–</button>
                        <button class="btn btn-primary" id="downloadBtn" onclick="downloadFile()" disabled>
                            â¬‡ï¸ ä¸‹è¼‰æª”æ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è™•ç†ä¸­å‹•ç•« -->
    <div id="processingOverlay" class="processing-overlay hidden">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text" id="processingText">æ­£åœ¨è™•ç†...</div>
            <div class="processing-detail" id="processingDetail"></div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let selectedType = null;
        let uploadedFile = null;
        let selectedFormat = null;
        let ocrData = null;

        // é¡å‹é…ç½®
        const typeConfig = {
            invoice: {
                icon: 'ğŸ“„',
                name: 'ç™¼ç¥¨',
                formats: [
                    { id: '406', name: '406 æ ¼å¼', desc: 'Excel æ ¼å¼è¼¸å‡º', icon: 'ğŸ“Š', ext: '.xlsx' },
                    { id: '407', name: '407 æ ¼å¼', desc: 'CSV æ ¼å¼è¼¸å‡º', icon: 'ğŸ“‹', ext: '.csv' }
                ],
                sampleData: {
                    'ç™¼ç¥¨è™Ÿç¢¼': 'AB-12345678',
                    'ç™¼ç¥¨æ—¥æœŸ': '2025-11-15',
                    'å®¢æˆ¶åç¨±': 'YGC èƒ½æºææ–™è‚¡ä»½æœ‰é™å…¬å¸',
                    'çµ±ä¸€ç·¨è™Ÿ': '12345678',
                    'å“é …': 'é‘„éµç®¡ä»¶é…ä»¶',
                    'æ•¸é‡': '500 ä»¶',
                    'æœªç¨…é‡‘é¡': 'NT$ 15,800',
                    'ç¨…é¡': 'NT$ 790',
                    'ç¸½è¨ˆ': 'NT$ 16,590',
                    'ç‹€æ…‹': 'âœ… å·²é–‹ç«‹'
                }
            },
            order: {
                icon: 'ğŸ›’',
                name: 'è¨‚å–®',
                formats: [
                    { id: 'CO', name: 'CO æ ¼å¼', desc: 'å®¢æˆ¶è¨‚å–®æ ¼å¼', icon: 'ğŸ“¦', ext: '.csv' },
                    { id: 'SO', name: 'SO æ ¼å¼', desc: 'éŠ·å”®è¨‚å–®æ ¼å¼', icon: 'ğŸ›ï¸', ext: '.csv' },
                    { id: 'TWO_STAGE', name: 'å…©éšæ®µæ ¼å¼', desc: 'å…©éšæ®µè™•ç†æ ¼å¼', icon: 'âš™ï¸', ext: '.csv' }
                ],
                sampleData: {
                    'è¨‚å–®ç·¨è™Ÿ': 'ORD-2025110001',
                    'è¨‚å–®æ—¥æœŸ': '2025-11-01',
                    'å®¢æˆ¶ä»£ç¢¼': 'C001',
                    'å®¢æˆ¶åç¨±': 'YGC èƒ½æºææ–™',
                    'ç”¢å“ä»£ç¢¼': 'P-CI-001',
                    'ç”¢å“åç¨±': 'é‘„éµç®¡ä»¶',
                    'æ•¸é‡': '500 ä»¶',
                    'å–®åƒ¹': 'NT$ 180',
                    'ç¸½é‡‘é¡': 'NT$ 90,000',
                    'äº¤æœŸ': '2025-11-25'
                }
            }
        };

        // ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ =====
        function selectType(type) {
            selectedType = type;
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.getElementById('invoiceCard').classList.remove('selected');
            document.getElementById('orderCard').classList.remove('selected');
            document.getElementById(type + 'Card').classList.add('selected');
            
            // å•Ÿç”¨ä¸Šå‚³å€åŸŸ
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.remove('disabled');
            uploadZone.onclick = () => document.getElementById('fileInput').click();
            uploadZone.querySelector('h3').textContent = 'ä¸Šå‚³ PDF æ–‡ä»¶';
            uploadZone.querySelector('p').textContent = 'é»æ“Šæˆ–æ‹–æ”¾ PDF æ–‡ä»¶åˆ°æ­¤è™• (æœ€å¤§ 10MB)';
        }

        // æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!uploadZone.classList.contains('disabled')) {
                uploadZone.classList.add('dragover');
            }
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (!uploadZone.classList.contains('disabled')) {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0]);
                }
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            uploadedFile = file;
            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2);
            
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileSize').textContent = `æª”æ¡ˆå¤§å°: ${fileSize} KB`;
            
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('fileInfoArea').classList.remove('hidden');
        }

        function removeFile() {
            uploadedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfoArea').classList.add('hidden');
        }

        // ===== ç¬¬äºŒå±¤ï¼šOCR è™•ç†èˆ‡çµæœ =====
        function startOCR() {
            showProcessing('æ­£åœ¨ä¸Šå‚³æ–‡ä»¶...', 'Azure Function è™•ç†ä¸­');
            
            setTimeout(() => {
                updateProcessing('æ­£åœ¨é€²è¡Œ OCR è¾¨è­˜...', 'Azure OpenAI Document Intelligence');
                
                setTimeout(() => {
                    updateProcessing('æ­£åœ¨çµæ§‹åŒ–è³‡æ–™...', 'è³‡æ–™æ ¼å¼åŒ–èˆ‡é©—è­‰');
                    
                    setTimeout(() => {
                        hideProcessing();
                        showOCRResults();
                    }, 1000);
                }, 2000);
            }, 1000);
        }

        function showOCRResults() {
            localStorage.setItem('selected_doc_type', selectedType);
            console.log("å·²è¨˜éŒ„æ–‡ä»¶é¡å‹:", selectedType);
            console.log("è¾¨è­˜å®Œæˆï¼Œè·³è½‰è‡³çµæœé ...");
            window.location.href = 'invoice_OCR_result.html';
        }

        function retryOCR() {
            if (confirm('ç¢ºå®šè¦é‡æ–°è¾¨è­˜å—ï¼Ÿé€™å°‡é‡æ–°è™•ç†ä¸Šå‚³çš„æ–‡ä»¶ã€‚')) {
                startOCR();
            }
        }

        function confirmOCR() {
            showFormatSelection();
        }

        // ===== ç¬¬ä¸‰å±¤ï¼šé¸æ“‡æ ¼å¼ =====
        function showFormatSelection() {
            updateStep(3);
            showLayer('layer3');
            
            const config = typeConfig[selectedType];
            
            // ç”Ÿæˆè³‡æ–™æ‘˜è¦ï¼ˆå–å‰3å€‹é—œéµæ¬„ä½ï¼‰
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = '';
            
            const summaryKeys = Object.keys(ocrData).slice(0, 3);
            summaryKeys.forEach(key => {
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `
                    <div class="label">${key}</div>
                    <div class="value">${ocrData[key]}</div>
                `;
                summaryGrid.appendChild(item);
            });
            
            // ç”Ÿæˆæ ¼å¼é¸é …
            const formatOptions = document.getElementById('formatOptions');
            formatOptions.innerHTML = '';
            
            config.formats.forEach(format => {
                const option = document.createElement('div');
                option.className = 'format-option';
                option.onclick = () => selectFormat(format.id);
                option.innerHTML = `
                    <div class="icon">${format.icon}</div>
                    <h4>${format.name}</h4>
                    <p>${format.desc}</p>
                `;
                option.dataset.formatId = format.id;
                formatOptions.appendChild(option);
            });
        }

        function selectFormat(formatId) {
            selectedFormat = formatId;
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.format-option').forEach(option => {
                if (option.dataset.formatId === formatId) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // å•Ÿç”¨ä¸‹è¼‰æŒ‰éˆ•
            document.getElementById('downloadBtn').disabled = false;
        }

        function downloadFile() {
            const config = typeConfig[selectedType];
            const format = config.formats.find(f => f.id === selectedFormat);
            
            if (!format) return;
            
            showProcessing('æ­£åœ¨ç”Ÿæˆæª”æ¡ˆ...', `è½‰æ›ç‚º ${format.name}${format.ext}`);
            
            setTimeout(() => {
                hideProcessing();
                alert(`âœ… æª”æ¡ˆå·²æº–å‚™å®Œæˆï¼\n\næª”æ¡ˆåç¨±: ${selectedType}_${Date.now()}${format.ext}\næ ¼å¼: ${format.name}\n\nå¯¦éš›éƒ¨ç½²æ™‚ï¼Œé€™è£¡æœƒèª¿ç”¨ API ä¸¦ä¸‹è¼‰æª”æ¡ˆã€‚`);
                
                // å¯ä»¥é¸æ“‡ç¹¼çºŒè™•ç†æˆ–é‡æ–°é–‹å§‹
                if (confirm('æ˜¯å¦è¦è™•ç†æ–°çš„æ–‡ä»¶ï¼Ÿ')) {
                    resetToStart();
                }
            }, 2000);
        }

        // ===== å°èˆªåŠŸèƒ½ =====
        function backToOCR() {
            updateStep(2);
            showLayer('layer2');
        }

        function resetToStart() {
            selectedType = null;
            uploadedFile = null;
            selectedFormat = null;
            ocrData = null;
            
            document.getElementById('invoiceCard').classList.remove('selected');
            document.getElementById('orderCard').classList.remove('selected');
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfoArea').classList.add('hidden');
            
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.add('disabled');
            uploadZone.onclick = null;
            uploadZone.querySelector('h3').textContent = 'è«‹å…ˆé¸æ“‡æ–‡ä»¶é¡å‹';
            uploadZone.querySelector('p').textContent = 'é¸æ“‡ä¸Šæ–¹çš„ç™¼ç¥¨æˆ–è¨‚å–®å¾Œå³å¯ä¸Šå‚³';
            
            updateStep(1);
            showLayer('layer1');
        }

        // ===== è¼”åŠ©åŠŸèƒ½ =====
        function updateStep(step) {
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (i === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            }
        }

        function showLayer(layerId) {
            ['layer1', 'layer2', 'layer3'].forEach(id => {
                const layer = document.getElementById(id);
                if (id === layerId) {
                    layer.classList.remove('hidden');
                } else {
                    layer.classList.add('hidden');
                }
            });
        }

        function showProcessing(text, detail) {
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingDetail').textContent = detail;
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        function updateProcessing(text, detail) {
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingDetail').textContent = detail;
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }
    </script>
</body>
</html>
