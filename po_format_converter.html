<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡è³¼å–®æ ¼å¼è½‰æ› & Excel ä¸‹è¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* è¾¨è­˜ç‡é¡¯ç¤ºæ¨£å¼ */
        .confidence-display {
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .confidence-icon {
            font-size: 24px;
        }

        .confidence-label {
            opacity: 0.9;
        }

        .confidence-value {
            font-size: 22px;
            font-weight: 700;
        }

        .confidence-value.high {
            color: #4cff4c;
            text-shadow: 0 0 10px rgba(76, 255, 76, 0.5);
        }

        .confidence-value.medium {
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .confidence-value.low {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .confidence-details {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .confidence-detail-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 12px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            margin-bottom: 30px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* JSON é è¦½å€ */
        .json-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
        }

        .json-preview pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* æ¡è³¼å–®åŸºæœ¬è³‡è¨Š */
        .po-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 16px;
            color: #212529;
            font-weight: 500;
            word-break: break-word;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 24px;
        }

        .summary-value:hover {
            background: #fff;
            border-color: #dee2e6;
        }

        .summary-value:focus {
            outline: none;
            background: #fff;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .summary-value.highlight {
            color: #667eea;
            font-size: 18px;
            font-weight: 700;
        }

        .summary-value.amount {
            color: #28a745;
            font-size: 20px;
            font-weight: 700;
        }

        .editable-hint {
            font-size: 11px;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
        }

        /* å…¶ä»–è³‡è¨Šå€å¡Š */
        .po-extra-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff8e1;
            border-radius: 8px;
            border: 1px solid #ffecb3;
        }

        .extra-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .extra-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .extra-label {
            font-size: 11px;
            color: #8d6e63;
            font-weight: 600;
        }

        .extra-value {
            font-size: 13px;
            color: #5d4037;
            word-break: break-word;
        }

        /* é …ç›®æ˜ç´°å¡ç‰‡å¼ä½ˆå±€ */
        .items-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .item-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.2s ease;
            position: relative;
        }

        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .item-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .item-line-no {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .item-amount-display {
            font-size: 18px;
            font-weight: 700;
            color: #28a745;
        }

        .item-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .item-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .item-field.wide {
            grid-column: span 2;
        }

        .item-field-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .item-field-value {
            font-size: 14px;
            color: #212529;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            min-height: 32px;
            transition: all 0.2s ease;
            white-space: pre-wrap;
        }

        .item-field-value:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .item-field-value:focus {
            outline: none;
            background: #fff;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .item-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-card:hover .item-delete-btn {
            opacity: 1;
        }

        .item-delete-btn:hover {
            background: #d32f2f;
        }

        .add-item-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            transition: all 0.2s ease;
        }

        .add-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .no-items-message {
            text-align: center;
            color: #999;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }

        /* æ ¼å¼é¸æ“‡å€ */
        .format-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .format-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .format-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .format-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .format-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .format-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 15px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .format-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .format-card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .format-card p {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .format-details {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: left;
            font-size: 12px;
            color: #555;
        }

        .format-details strong {
            color: #333;
        }

        /* åƒæ•¸è¨­ç½® */
        .parameters {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-group:last-child {
            margin-bottom: 0;
        }

        .param-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .param-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            transition: border-color 0.3s ease;
        }

        .param-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .param-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* æŒ‰éˆ•å€ */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é€²åº¦æç¤º */
        .progress-message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .progress-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .progress-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .progress-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .progress-message.show {
            display: block;
        }

        /* è³‡è¨Šç›’ */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px 20px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 13px;
            color: #1565c0;
            line-height: 1.6;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .format-selection {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="header">
            <h1>ğŸ“¦ æ¡è³¼å–®æ ¼å¼è½‰æ›ç³»çµ±</h1>
            <p>OCR è¾¨è­˜çµæœè½‰æ›ç‚ºæ¨™æº– Excel æ ¼å¼</p>
            <!-- è¾¨è­˜ç‡é¡¯ç¤º -->
            <div id="confidenceDisplay" class="confidence-display" style="display: none;">
                <div class="confidence-badge" id="mainConfidenceBadge">
                    <span class="confidence-icon">ğŸ¯</span>
                    <span class="confidence-label">OCR è¾¨è­˜ç‡:</span>
                    <span class="confidence-value" id="confidenceValue">-</span>
                </div>
                <div class="confidence-details" id="confidenceDetails"></div>
            </div>
        </div>

        <!-- JSON é è¦½å¡ç‰‡ -->
        <div class="card">
            <div class="section-title">ğŸ“‹ OCR è¾¨è­˜çµæœ</div>
            <div class="json-preview">
                <pre id="jsonPreview">ç­‰å¾… JSON è³‡æ–™...</pre>
            </div>

            <!-- æ•¸æ“šè¡¨æ ¼ -->
            <div class="data-table-container" id="tableContainer" style="display: none;">
                <!-- æ¡è³¼å–®åŸºæœ¬è³‡è¨Šæ‘˜è¦ -->
                <div class="po-summary" id="poSummary">
                    <div class="summary-item">
                        <span class="summary-label">ğŸ“„ æ¡è³¼å–®è™Ÿ</span>
                        <span class="summary-value highlight" id="summaryPONo" contenteditable="true" data-field="poNo">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ“… æ¡è³¼æ—¥æœŸ</span>
                        <span class="summary-value" id="summaryPODate" contenteditable="true" data-field="poDate">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ¢ è²·æ–¹å…¬å¸</span>
                        <span class="summary-value" id="summaryBuyer" contenteditable="true" data-field="buyer">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ­ ä¾›æ‡‰å•†</span>
                        <span class="summary-value" id="summarySeller" contenteditable="true" data-field="seller">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ’µ å¹£åˆ¥</span>
                        <span class="summary-value" id="summaryCurrency" contenteditable="true" data-field="currency">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ“¦ å“é …æ•¸é‡</span>
                        <span class="summary-value" id="summaryItemCount">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ğŸ’° è¨‚è³¼ç¸½é¡</span>
                        <span class="summary-value amount" id="summaryTotal" contenteditable="true" data-field="totalAmount">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">â° äº¤è²¨æœŸ</span>
                        <span class="summary-value" id="summaryDeliveryDate" contenteditable="true" data-field="deliveryDate">-</span>
                    </div>
                </div>
                <div class="editable-hint">ğŸ’¡ æç¤ºï¼šé»æ“Šä¸Šæ–¹æ¬„ä½å¯ç›´æ¥ç·¨è¼¯ä¿®æ­£ OCR è¾¨è­˜çµæœ</div>

                <!-- å…¶ä»–è³‡è¨Šï¼ˆå¯é¸é¡¯ç¤ºï¼‰ -->
                <div class="po-extra-info" id="extraInfoSection" style="display: none;">
                    <div class="extra-info-grid">
                        <div class="extra-item" id="extraBuyerAddress" style="display: none;">
                            <span class="extra-label">ğŸ“ è²·æ–¹åœ°å€</span>
                            <span class="extra-value" id="valBuyerAddress">-</span>
                        </div>
                        <div class="extra-item" id="extraSellerAddress" style="display: none;">
                            <span class="extra-label">ğŸ“ ä¾›æ‡‰å•†åœ°å€</span>
                            <span class="extra-value" id="valSellerAddress">-</span>
                        </div>
                        <div class="extra-item" id="extraDeliveryAddress" style="display: none;">
                            <span class="extra-label">ğŸ“¦ æ”¶è²¨åœ°å€</span>
                            <span class="extra-value" id="valDeliveryAddress">-</span>
                        </div>
                        <div class="extra-item" id="extraContact" style="display: none;">
                            <span class="extra-label">ğŸ“ è¯çµ¡æ–¹å¼</span>
                            <span class="extra-value" id="valContact">-</span>
                        </div>
                        <div class="extra-item" id="extraPaymentTerm" style="display: none;">
                            <span class="extra-label">ğŸ’³ ä»˜æ¬¾æ¢ä»¶</span>
                            <span class="extra-value" id="valPaymentTerm">-</span>
                        </div>
                        <div class="extra-item" id="extraShippingTerm" style="display: none;">
                            <span class="extra-label">ğŸš¢ é…é€æ¢ä»¶</span>
                            <span class="extra-value" id="valShippingTerm">-</span>
                        </div>
                        <div class="extra-item" id="extraRemarks" style="display: none;">
                            <span class="extra-label">ğŸ“ å‚™è¨»</span>
                            <span class="extra-value" id="valRemarks">-</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 25px; margin-bottom: 15px;">ğŸ“Š æ¡è³¼é …ç›®æ˜ç´°</h3>
                <div class="items-container" id="itemsContainer">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„é …ç›®å¡ç‰‡ -->
                </div>
                <button class="add-item-btn" onclick="addNewItem()">
                    â• æ–°å¢é …ç›®
                </button>
            </div>
        </div>

        <!-- æ ¼å¼é¸æ“‡å¡ç‰‡ -->
        <div class="card">
            <div class="section-title">ğŸ¯ é¸æ“‡è¼¸å‡ºæ ¼å¼</div>
            
            <div class="format-selection" style="grid-template-columns: 1fr 1fr 1fr;">
                <!-- CO æ ¼å¼ -->
                <div class="format-card" id="formatCO" onclick="selectFormat('CO')">
                    <div class="format-icon">ğŸ“¦</div>
                    <h3>CO æ ¼å¼</h3>
                    <p>å®¢æˆ¶è¨‚å–®</p>
                    <div class="format-details">
                        <strong>é©ç”¨æ–¼ï¼š</strong>
                        <ul style="margin-left: 15px; margin-top: 5px;">
                            <li>å‘ä¸Šæ¸¸ä¾›æ‡‰å•†ä¸‹å–®</li>
                            <li>æ¡è³¼ç®¡ç†</li>
                        </ul>
                    </div>
                </div>

                <!-- SO æ ¼å¼ -->
                <div class="format-card" id="formatSO" onclick="selectFormat('SO')">
                    <div class="format-icon">ğŸ“‹</div>
                    <h3>SO æ ¼å¼</h3>
                    <p>éŠ·å”®è¨‚å–®</p>
                    <div class="format-details">
                        <strong>é©ç”¨æ–¼ï¼š</strong>
                        <ul style="margin-left: 15px; margin-top: 5px;">
                            <li>å¨å¥å…§éƒ¨éŠ·å”®</li>
                            <li>è¨‚å–®è™•ç†</li>
                        </ul>
                    </div>
                </div>

                <!-- å…©éšæ®µ æ ¼å¼ -->
                <div class="format-card" id="formatTWOSTAGE" onclick="selectFormat('TWOSTAGE')">
                    <div class="format-icon">ğŸ”„</div>
                    <h3>å…©éšæ®µæ ¼å¼</h3>
                    <p>å€‰åº«èª¿æ’¥</p>
                    <div class="format-details">
                        <strong>é©ç”¨æ–¼ï¼š</strong>
                        <ul style="margin-left: 15px; margin-top: 5px;">
                            <li>å€‰åº«è½‰ç§»</li>
                            <li>åº«å­˜èª¿æ’¥</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- åƒæ•¸è¨­ç½® (éš±è—) -->
            <div class="parameters" style="display: none;">
                <div class="param-group">
                    <label class="param-label">ğŸ“ å–®è™Ÿ / è¨‚å–®åç¨±</label>
                    <input type="text" id="paramValue" class="param-input"
                           placeholder="AUTO (è‡ªå‹•ç”Ÿæˆ)" value="AUTO">
                    <div class="param-hint">
                        CO: å®¢æˆ¶è¨‚å–®è™Ÿ (Co_Number) - é è¨­: AUTO<br>
                        SO: ä¸Šå‚³ç·¨è™Ÿ (Upload_No) - é è¨­: AUTO<br>
                        å…©éšæ®µ: è¨‚å–®å - é è¨­: AUTO
                    </div>
                </div>
            </div>

            <!-- é€²åº¦æç¤º -->
            <div id="progressMessage" class="progress-message"></div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="downloadExcel()" id="downloadBtn" disabled>
                    ğŸ’¾ ä¸‹è¼‰ Excel
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    ğŸ”„ é‡ç½®
                </button>
            </div>

            <!-- è³‡è¨Šç›’ -->
            <div class="info-box">
                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong>
                1. ä¸Šå‚³æˆ–è²¼ä¸Š OCR è¾¨è­˜çµæœ JSON<br>
                2. é¸æ“‡è¼¸å‡ºæ ¼å¼ (406INF æˆ– 407INF)<br>
                3. ä¿®æ”¹åƒæ•¸åç¨±ï¼ˆå¯é¸ï¼‰<br>
                4. é»æ“Šã€Œä¸‹è¼‰ Excelã€ç”Ÿæˆæª”æ¡ˆ
            </div>
        </div>
    </div>

    <script>
        let selectedFormat = null;
        let poData = null;

        // è½‰æ› Azure OCR åŸå§‹çµæœç‚ºçµæ§‹åŒ–æ ¼å¼ï¼ˆé‡å°å°ç£æ¡è³¼å–®å„ªåŒ–ï¼‰
        function parseOCRRawResult(ocrRaw) {
            if (!ocrRaw.pages || ocrRaw.pages.length === 0) {
                return null;
            }

            const lines = ocrRaw.pages[0].lines.map(line => line.text.trim());
            const structured = {
                poNo: '',
                poDate: '',
                buyer: '',
                seller: '',
                sellerAddress: '',
                sellerPhone: '',
                buyerAddress: '',
                deliveryAddress: '',
                contact: '',
                paymentTerm: '',
                totalAmount: 0,
                currency: 'USD',
                deliveryDate: '',
                remarks: '',
                items: []
            };

            console.log('ğŸ“Š é–‹å§‹è§£ææ¡è³¼å–®ï¼Œå…± ' + lines.length + ' è¡Œ');

            // 1. æå–è²·æ–¹å…¬å¸åç¨±ï¼ˆé€šå¸¸åœ¨ç¬¬ä¸€è¡Œï¼Œä½†å¦‚æœç¬¬ä¸€è¡ŒåŒ…å«"è‚¡ä»½æœ‰é™å…¬å¸"å¯èƒ½æ˜¯è²·æ–¹ï¼‰
            if (lines.length > 0 && lines[0].includes('è‚¡ä»½æœ‰é™å…¬å¸') && !lines[0].includes('å» å•†')) {
                structured.buyer = lines[0];
                console.log('ğŸ¢ è²·æ–¹ï¼š' + structured.buyer);
            }

            // 2. æå–æ¡è³¼å–®è™Ÿ (æ¡è³¼å–®è™Ÿ:XXXXX æˆ– æ¡è³¼å–®è™Ÿï¼šXXXXX) - åŒä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
            console.log('ğŸŸ¦ é–‹å§‹æå–æ¡è³¼å–®è™Ÿï¼Œç•¶å‰å€¼ï¼š[' + structured.poNo + ']ï¼Œlines é•·åº¦ï¼š' + lines.length);
            
            if (!structured.poNo) {
                console.log('ğŸ”„ è¿›å…¥ lines è¿´åœˆæå–æ¡è³¼å–®è™Ÿ...');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i] && lines[i].includes('æ¡è³¼å–®è™Ÿ')) {
                        console.log('ğŸ” æ‰¾åˆ°æ¡è³¼å–®è™Ÿè¡Œï¼ˆç¬¬' + i + 'è¡Œï¼‰ï¼š[' + lines[i] + ']');
                        
                        // æœ€ç›´æ¥çš„æ–¹æ³•ï¼šæ‰¾åˆ°ã€Œæ¡è³¼å–®è™Ÿã€å¾Œçš„æ‰€æœ‰æ•¸å­—
                        const idx = lines[i].indexOf('æ¡è³¼å–®è™Ÿ');
                        if (idx >= 0) {
                            // å¾ã€Œæ¡è³¼å–®è™Ÿã€å¾Œé–‹å§‹æå–
                            const afterLabel = lines[i].substring(idx + 4); // 'æ¡è³¼å–®è™Ÿ' æ˜¯ 4 å€‹å­—å…ƒ
                            console.log('ğŸ“ ã€Œæ¡è³¼å–®è™Ÿã€å¾Œçš„å…§å®¹ï¼š[' + afterLabel + ']');
                            
                            // ç›´æ¥æå–ç¬¬ä¸€å€‹æ•¸å­—åºåˆ—
                            const numMatch = afterLabel.match(/\d+/);
                            console.log('ğŸ”¢ æ•¸å­—åŒ¹é…çµæœï¼š', numMatch);
                            if (numMatch) {
                                structured.poNo = numMatch[0];
                                console.log('âœ… æ¡è³¼å–®è™Ÿå·²æå–ï¼ˆç›´æ¥æ–¹æ³•ï¼‰ï¼š[' + structured.poNo + ']');
                                break;
                            }
                        }
                        
                        // å¦‚æœä¸Šé¢å¤±æ•—ï¼Œè©¦è©¦æ­£å‰‡
                        if (!structured.poNo) {
                            let match = lines[i].match(/æ¡è³¼å–®è™Ÿ[\sï¼š:]*(\d+)/);
                            if (!match) {
                                match = lines[i].match(/æ¡è³¼å–®è™Ÿ[ï¼š:](\d+)/);
                            }
                            if (!match) {
                                match = lines[i].match(/æ¡è³¼å–®è™Ÿ(\d+)/);
                            }
                            
                            if (match && match[1]) {
                                structured.poNo = match[1];
                                console.log('âœ… æ¡è³¼å–®è™Ÿå·²æå–ï¼ˆæ­£å‰‡æ–¹æ³•ï¼‰ï¼š[' + structured.poNo + ']');
                                break;
                            }
                        }
                    }
                }
            } else {
                console.log('â­ï¸ æ¡è³¼å–®è™Ÿå·²æœ‰å€¼ï¼Œè·³é lines æå–');
            }
            
            // æœ€å¾Œæª¢æŸ¥æ˜¯å¦æˆåŠŸ
            console.log('ğŸ“Œ æœ€çµ‚æ¡è³¼å–®è™Ÿçµæœï¼ˆlines éšæ®µå¾Œï¼‰ï¼š[' + (structured.poNo || 'ç©º') + ']');

            // 3. æå–æ¡è³¼æ—¥æœŸ (è£½è¡¨æ—¥æœŸ:YYYY/MM/DD æˆ– å–®æ“šæ—¥æœŸ:YYYY/MM/DD) - åŒä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
            if (!structured.poDate) {
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('è£½è¡¨æ—¥æœŸ') || lines[i].includes('å–®æ“šæ—¥æœŸ')) {
                        let match = lines[i].match(/(\d{4})[\s\/](\d{2})[\s\/](\d{2})/);
                        if (!match && i + 1 < lines.length) {
                            match = lines[i + 1].match(/(\d{4})[\s\/](\d{2})[\s\/](\d{2})/);
                        }
                        if (match) {
                            structured.poDate = match[1] + '/' + match[2] + '/' + match[3];
                            console.log('ğŸ“… æ¡è³¼æ—¥æœŸï¼š' + structured.poDate);
                            break;
                        }
                    }
                }
            }

            // 4. æå–äº¤æ˜“å¹£åˆ¥ (äº¤æ˜“å¹£åˆ¥:USD æˆ– äº¤æ˜“å¹£åˆ¥ï¼šUSD) - åŒä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
            if (!structured.currency || structured.currency === 'USD') {
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('äº¤æ˜“å¹£åˆ¥')) {
                        // æ”¯æ´åŠå½¢å†’è™Ÿ : å’Œå…¨å½¢å†’è™Ÿ ï¼š
                        let match = lines[i].match(/äº¤æ˜“å¹£åˆ¥[\sï¼š:]*([A-Z]{3})/);
                        if (!match && i + 1 < lines.length) {
                            match = lines[i + 1].match(/^([A-Z]{3})/);
                        }
                        if (match) {
                            structured.currency = match[1].trim();
                            console.log('ğŸ’µ å¹£åˆ¥ï¼š' + structured.currency);
                            break;
                        }
                    }
                }
            }

            // 5. å¾è¡¨æ ¼å„ªå…ˆæå–ä¾›æ‡‰å•†å’Œåœ°å€ä¿¡æ¯ï¼Œä»¥åŠæ¡è³¼å–®è™Ÿå’Œæ—¥æœŸ
            if (ocrRaw.tables && ocrRaw.tables.length > 0) {
                console.log('ğŸŸ© é–‹å§‹æå–è¡¨æ ¼è³‡æ–™ï¼Œè¡¨æ ¼æ•¸ï¼š' + ocrRaw.tables.length);
                const headerTable = ocrRaw.tables[0];  // ç¬¬ä¸€å€‹è¡¨é€šå¸¸æ˜¯é é ­è³‡è¨Š
                console.log('ğŸ“Š è¡¨æ ¼0å–®å…ƒæ•¸ï¼š' + (headerTable.cells ? headerTable.cells.length : 0));
                
                // å¾è¡¨æ ¼å–®å…ƒæå–æ‰€æœ‰ä¿¡æ¯
                for (let cell of headerTable.cells) {
                    if (!cell.content) continue;
                    
                    const content = cell.content;
                    
                    // æ¡è³¼å–®è™Ÿ
                    if (content.includes('æ¡è³¼å–®è™Ÿ') && !structured.poNo) {
                        console.log('ğŸ” è¡¨æ ¼ä¸­æ‰¾åˆ°æ¡è³¼å–®è™Ÿå–®å…ƒï¼š[' + content + ']');
                        
                        // ç›´æ¥æå–æ–¹æ³•
                        const idx = content.indexOf('æ¡è³¼å–®è™Ÿ');
                        if (idx >= 0) {
                            const afterLabel = content.substring(idx + 4); // 'æ¡è³¼å–®è™Ÿ' æ˜¯ 4 å€‹å­—å…ƒ
                            const numMatch = afterLabel.match(/\d+/);
                            console.log('ğŸ”¢ è¡¨æ ¼æ•¸å­—åŒ¹é…ï¼š', numMatch);
                            if (numMatch) {
                                structured.poNo = numMatch[0];
                                console.log('âœ… è¡¨æ ¼æ¡è³¼å–®è™Ÿå·²æå–ï¼ˆç›´æ¥æ–¹æ³•ï¼‰ï¼š[' + structured.poNo + ']');
                            }
                        }
                        
                        // å¦‚æœå¤±æ•—ï¼Œè©¦è©¦æ­£å‰‡
                        if (!structured.poNo) {
                            let match = content.match(/æ¡è³¼å–®è™Ÿ[\sï¼š:]*(\d+)/);
                            if (!match) {
                                match = content.match(/æ¡è³¼å–®è™Ÿ[ï¼š:](\d+)/);
                            }
                            if (!match) {
                                match = content.match(/æ¡è³¼å–®è™Ÿ(\d+)/);
                            }
                            
                            if (match && match[1]) {
                                structured.poNo = match[1];
                                console.log('âœ… è¡¨æ ¼æ¡è³¼å–®è™Ÿå·²æå–ï¼ˆæ­£å‰‡æ–¹æ³•ï¼‰ï¼š[' + structured.poNo + ']');
                            }
                        }
                    }
                    
                    // å–®æ“šæ—¥æœŸ/è£½è¡¨æ—¥æœŸ
                    if ((content.includes('å–®æ“šæ—¥æœŸ') || content.includes('è£½è¡¨æ—¥æœŸ')) && !structured.poDate) {
                        const match = content.match(/(?:å–®æ“šæ—¥æœŸ|è£½è¡¨æ—¥æœŸ)[\sï¼š:]*(\d{4})[\s\/](\d{2})[\s\/](\d{2})/);
                        if (match) {
                            structured.poDate = match[1] + '/' + match[2] + '/' + match[3];
                            console.log('ğŸ“… æ¡è³¼æ—¥æœŸï¼š' + structured.poDate);
                        }
                    }
                    
                    // å» å•†å…¨å
                    if (content.includes('å» å•†å…¨å') && !structured.seller) {
                        const match = content.match(/å» å•†å…¨å[\sï¼š:]*(.+?)(?:\n|$)/);
                        if (match) {
                            structured.seller = match[1].trim();
                            console.log('ğŸ­ ä¾›æ‡‰å•†ï¼š' + structured.seller);
                        }
                    }
                    
                    // å» å•†åœ°å€
                    if (content.includes('å» å•†åœ°å€') && !structured.sellerAddress) {
                        const match = content.match(/å» å•†åœ°å€[\sï¼š:]*(.+?)(?:\n|$)/);
                        if (match) {
                            structured.sellerAddress = match[1].trim();
                            console.log('ğŸ“ å» å•†åœ°å€ï¼š' + structured.sellerAddress);
                        }
                    }
                    
                    // å» å•†é›»è©±
                    if (content.includes('å» å•†é›»è©±') && !structured.sellerPhone) {
                        const match = content.match(/å» å•†é›»è©±[\sï¼š:]*(.+?)(?:\n|$)/);
                        if (match) {
                            structured.sellerPhone = match[1].trim();
                        }
                    }
                    
                    // é€è²¨åœ°å€
                    if (content.includes('é€è²¨åœ°å€') && !structured.deliveryAddress) {
                        // æå–é€è²¨åœ°å€å¾Œé¢çš„å…§å®¹ï¼ˆå¯èƒ½è·¨è¡Œï¼‰
                        const match = content.match(/é€è²¨åœ°å€[\sï¼š:]*\n*(.+?)$/s);
                        if (match && match[1].trim()) {
                            structured.deliveryAddress = match[1].trim();
                            console.log('ğŸ“¦ é€è²¨åœ°å€ï¼š' + structured.deliveryAddress);
                        }
                    }
                    
                    // è¯çµ¡äºº
                    if ((content.includes('è¯ çµ¡ äºº') || content.includes('è¯çµ¡äºº')) && !structured.contact) {
                        // æå–è¯çµ¡äººå¾Œé¢çš„å…§å®¹
                        const match = content.match(/è¯\s*çµ¡\s*äºº[\sï¼š:]*(.+?)(?:å» å•†|é€è²¨|$)/s);
                        if (match && match[1].trim()) {
                            // å–ç¬¬ä¸€è¡Œä½œç‚ºè¯çµ¡äºº
                            const contactLines = match[1].split('\n').map(l => l.trim()).filter(l => l);
                            if (contactLines.length > 0) {
                                structured.contact = contactLines[0];
                                console.log('ğŸ“ è¯çµ¡äººï¼š' + structured.contact);
                            }
                        }
                    }

                    // ä»˜æ¬¾æ¢ä»¶ - å¾åŒä¸€è¡Œæå–ä»£ç¢¼
                    if (content.includes('ä»˜æ¬¾æ¢ä»¶') && !structured.paymentTerm) {
                        const match = content.match(/ä»˜æ¬¾æ¢ä»¶[\sï¼š:]*(\d+)/);
                        if (match) {
                            // æå–ä»˜æ¬¾æ¢ä»¶ä»£ç¢¼ï¼Œç„¶å¾Œæ‰¾åŒä¸€è¡Œçš„ä¸‹ä¸€å€‹å„²å­˜æ ¼
                            const rowIdx = cell.rowIndex;
                            const colIdx = cell.columnIndex;
                            // æ‰¾åŒä¸€è¡Œä¸‹ä¸€åˆ—
                            const nextCell = headerTable.cells.find(c => c.rowIndex === rowIdx && c.columnIndex === colIdx + 1);
                            if (nextCell && nextCell.content) {
                                structured.paymentTerm = match[1] + ' ' + nextCell.content.trim();
                            } else {
                                structured.paymentTerm = match[1];
                            }
                            console.log('ğŸ’³ ä»˜æ¬¾æ¢ä»¶ï¼š' + structured.paymentTerm);
                        }
                    }
                }
            }

            // 6. å¾ lines è£œå……æˆ–è¦†è“‹ä¾›æ‡‰å•†ä¿¡æ¯ï¼ˆå‚™ç”¨ï¼‰
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('å» å•†å…¨å') && !structured.seller) {
                    let value = '';
                    // æ”¯æ´åŠå½¢å†’è™Ÿ : å’Œå…¨å½¢å†’è™Ÿ ï¼š
                    const match = lines[i].match(/å» å•†å…¨å[\sï¼š:]*(.+?)$/);
                    if (match && match[1].trim()) {
                        value = match[1].trim();
                    } else if (i + 1 < lines.length && lines[i + 1].trim() && !lines[i + 1].match(/[:ï¼š]/)) {
                        value = lines[i + 1];
                    }
                    if (value) {
                        structured.seller = value;
                        console.log('ğŸ­ ä¾›æ‡‰å•†ï¼ˆfrom linesï¼‰ï¼š' + structured.seller);
                    }
                }
                
                if (lines[i].includes('å» å•†åœ°å€') && !structured.sellerAddress) {
                    let value = '';
                    // æ”¯æ´åŠå½¢å†’è™Ÿ : å’Œå…¨å½¢å†’è™Ÿ ï¼š
                    const match = lines[i].match(/å» å•†åœ°å€[\sï¼š:]*(.+?)$/);
                    if (match && match[1].trim()) {
                        value = match[1].trim();
                    } else if (i + 1 < lines.length && lines[i + 1].trim() && !lines[i + 1].match(/[:ï¼š]/)) {
                        value = lines[i + 1];
                    }
                    if (value) {
                        structured.sellerAddress = value;
                        console.log('ğŸ“ å» å•†åœ°å€ï¼ˆfrom linesï¼‰ï¼š' + structured.sellerAddress);
                    }
                }
                
                if ((lines[i].includes('è¯ çµ¡ äºº') || lines[i].includes('è¯çµ¡äºº')) && !structured.contact) {
                    structured.contact = lines[i];
                }
            }

            // 7. æå–ä»˜æ¬¾æ¢ä»¶
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('ä»˜æ¬¾æ¢ä»¶')) {
                    const match = lines[i].match(/ä»˜æ¬¾æ¢ä»¶[:\s]*(.+?)(?:\n|$)/);
                    if (match && match[1].trim()) {
                        structured.paymentTerm = match[1].trim();
                    } else if (i + 1 < lines.length) {
                        const nextMatch = lines[i + 1].match(/^[^\n]*[^\s].*$/);
                        if (nextMatch && lines[i + 1].length > 2) {
                            structured.paymentTerm = lines[i + 1];
                        }
                    }
                    if (structured.paymentTerm) {
                        console.log('ğŸ’³ ä»˜æ¬¾æ¢ä»¶ï¼š' + structured.paymentTerm);
                        break;
                    }
                }
            }

            // 8. æå–å‚™è¨»
            for (let i = 0; i < lines.length; i++) {
                if ((lines[i].includes('å‚™') && lines[i].includes('è¨»')) || lines[i] === 'å‚™è¨»') {
                    const match = lines[i].match(/å‚™\s*è¨»[:\s]*(.+?)(?:\n|$)/);
                    if (match) {
                        structured.remarks = match[1].trim();
                    } else if (i + 1 < lines.length && lines[i + 1].trim()) {
                        structured.remarks = lines[i + 1];
                    }
                    if (structured.remarks) {
                        console.log('ğŸ“ å‚™è¨»ï¼š' + structured.remarks);
                        break;
                    }
                }
            }

            // 9. ä½¿ç”¨è¡¨æ ¼è³‡è¨Šè§£æé …ç›®ï¼ˆç¬¬äºŒå€‹è¡¨é€šå¸¸æ˜¯é …ç›®è¡¨ï¼‰
            if (ocrRaw.tables && ocrRaw.tables.length > 1) {
                console.log('ğŸ“Š ä½¿ç”¨è¡¨æ ¼æ–¹å¼è§£æé …ç›®...');
                const itemTable = ocrRaw.tables[1];
                
                // æ‰¾åˆ°è¡¨é ­ï¼ˆç¬¬ 0 åˆ—ï¼‰
                const headerCells = itemTable.cells.filter(cell => cell.rowIndex === 0);
                console.log('ğŸ“‹ é …ç›®è¡¨é ­åˆ—æ•¸ï¼š' + headerCells.length);

                // å¾ç¬¬ 1 åˆ—é–‹å§‹è§£æé …ç›®
                for (let rowIdx = 1; rowIdx < itemTable.rowCount; rowIdx++) {
                    const rowCells = itemTable.cells.filter(cell => cell.rowIndex === rowIdx);
                    
                    // æª¢æŸ¥åºè™Ÿæ¬„ï¼ˆç¬¬ 0 åˆ—ï¼‰
                    const seqCell = rowCells.find(cell => cell.columnIndex === 0);
                    if (!seqCell || !seqCell.content || seqCell.content.trim() === '') {
                        console.log('âŠ˜ ç¬¬ ' + rowIdx + ' åˆ—åºè™Ÿç‚ºç©ºï¼Œè·³é');
                        continue;
                    }

                    const seqMatch = seqCell.content.match(/(\d+)/);
                    if (!seqMatch) {
                        console.log('âŠ˜ ç¬¬ ' + rowIdx + ' åˆ—åºè™Ÿéæ•¸å­—ï¼Œè·³é');
                        continue;
                    }

                    const lineNo = parseInt(seqMatch[1]);
                    console.log('ğŸ“Œ è§£æé …ç›®è¡¨ç¬¬ ' + rowIdx + ' åˆ—ï¼Œåºè™Ÿï¼š' + lineNo);

                    // æå–å„æ¬„ä½
                    const item = {
                        lineNo: lineNo,
                        itemNo: '',
                        description: '',
                        quantity: 0,
                        unit: '',
                        unitPrice: 0,
                        amount: 0,
                        deliveryDate: '',
                        remarks: ''
                    };

                    // åˆ— 1: å“è™Ÿã€å“åã€è¦æ ¼
                    const prodCell = rowCells.find(cell => cell.columnIndex === 1);
                    if (prodCell && prodCell.content) {
                        const cellLines = prodCell.content.split('\n').map(l => l.trim()).filter(l => l && l !== 'ä»¥ä¸‹ç©ºç™½//');
                        if (cellLines.length > 0) item.itemNo = cellLines[0];      // å“è™Ÿ
                        if (cellLines.length > 1) item.description = cellLines[1]; // å“å
                        if (cellLines.length > 2) item.remarks = cellLines[2];     // è¦æ ¼
                    }

                    // åˆ— 2: æ¡è³¼æ•¸é‡ã€å·²äº¤æ•¸é‡
                    const qtyCell = rowCells.find(cell => cell.columnIndex === 2);
                    if (qtyCell && qtyCell.content) {
                        const qtyMatch = qtyCell.content.match(/^(\d+)/);
                        if (qtyMatch) item.quantity = parseInt(qtyMatch[1]);
                    }

                    // åˆ— 3: å–®ä½
                    const unitCell = rowCells.find(cell => cell.columnIndex === 3);
                    if (unitCell && unitCell.content) {
                        item.unit = unitCell.content.trim() || 'PCS';
                    }

                    // åˆ— 4: äº¤è²¨åº«åˆ¥ã€æ¡è³¼å–®åƒ¹ã€æ¡è³¼é‡‘é¡
                    const priceCell = rowCells.find(cell => cell.columnIndex === 4);
                    if (priceCell && priceCell.content) {
                        const parts = priceCell.content.split('\n').map(l => l.trim()).filter(l => l && l.match(/^[\d.]+$/));
                        if (parts.length >= 2) {
                            item.unitPrice = parseFloat(parts[parts.length - 2]) || 0;  // å€’æ•¸ç¬¬ 2 å€‹æ˜¯å–®åƒ¹
                            item.amount = parseFloat(parts[parts.length - 1]) || 0;      // æœ€å¾Œä¸€å€‹æ˜¯é‡‘é¡
                        } else if (parts.length === 1) {
                            item.amount = parseFloat(parts[0]) || 0;
                        }
                    }

                    // åˆ— 5: é äº¤æ—¥
                    const delivCell = rowCells.find(cell => cell.columnIndex === 5);
                    if (delivCell && delivCell.content) {
                        const dateMatch = delivCell.content.match(/(\d{4})[\s\/](\d{2})[\s\/](\d{2})/);
                        if (dateMatch) {
                            item.deliveryDate = dateMatch[1] + '/' + dateMatch[2] + '/' + dateMatch[3];
                            if (!structured.deliveryDate) {
                                structured.deliveryDate = item.deliveryDate;
                            }
                        }
                    }

                    // é©—è­‰é …ç›®æœ‰æ•ˆæ€§
                    if (item.quantity > 0 && item.itemNo) {
                        structured.items.push(item);
                        console.log('âœ… é …ç›® ' + lineNo + ' å·²ä¿å­˜ï¼š', item);
                    } else {
                        console.log('âŠ˜ é …ç›® ' + lineNo + ' ç„¡æ•ˆï¼ˆç¼ºå°‘å“è™Ÿæˆ–æ•¸é‡ï¼‰ï¼Œè·³é');
                    }
                }
            }

            // 10. æå–ç¸½é‡‘é¡ (æ¡è³¼é‡‘é¡: æˆ– é‡‘é¡åˆè¨ˆ:)
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('é‡‘é¡åˆè¨ˆ') && !structured.totalAmount) {
                    // æª¢æŸ¥åŒè¡Œæ˜¯å¦æœ‰æ•¸å€¼
                    const sameLineMatch = lines[i].match(/é‡‘é¡åˆè¨ˆ[:\s]*([\d,]+\.?\d*)/);
                    if (sameLineMatch) {
                        structured.totalAmount = parseFloat(sameLineMatch[1].replace(/,/g, ''));
                    } else if (i + 1 < lines.length) {
                        const nextMatch = lines[i + 1].match(/^([\d,]+\.?\d*)$/);
                        if (nextMatch) {
                            structured.totalAmount = parseFloat(nextMatch[1].replace(/,/g, ''));
                        }
                    }
                    if (structured.totalAmount) {
                        console.log('ğŸ’° ç¸½é‡‘é¡ï¼š' + structured.totalAmount);
                        break;
                    }
                }
            }

            console.log('âœ… è§£æå®Œæˆï¼Œå…± ' + structured.items.length + ' å€‹é …ç›®');
            return structured;
        }

        // æ¸²æŸ“æ•¸æ“šè¡¨æ ¼
        function renderDataTable() {
            const itemsContainer = document.getElementById('itemsContainer');
            const tableContainer = document.getElementById('tableContainer');
            
            if (!poData) {
                tableContainer.style.display = 'none';
                return;
            }

            // æ›´æ–°æ¡è³¼å–®æ‘˜è¦è³‡è¨Š
            document.getElementById('summaryPONo').textContent = poData.poNo || '-';
            document.getElementById('summaryPODate').textContent = poData.poDate || '-';
            document.getElementById('summaryBuyer').textContent = (poData.buyer || '-').replace(/\n/g, ' / ');
            document.getElementById('summarySeller').textContent = (poData.seller || '-').replace(/\n/g, ' / ');
            document.getElementById('summaryCurrency').textContent = poData.currency || 'USD';
            document.getElementById('summaryItemCount').textContent = poData.items ? `${poData.items.length} é …` : '0 é …';
            document.getElementById('summaryDeliveryDate').textContent = poData.deliveryDate || '-';
            document.getElementById('summaryTotal').textContent = poData.totalAmount 
                ? `${poData.currency || 'USD'} ${poData.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                : '-';

            // æ›´æ–°å…¶ä»–è³‡è¨Šï¼ˆæœ‰å€¼æ‰é¡¯ç¤ºï¼‰
            const extraSection = document.getElementById('extraInfoSection');
            let hasExtraInfo = false;

            // é‡ç½®æ‰€æœ‰ extra æ¬„ä½
            document.querySelectorAll('.extra-item').forEach(el => el.style.display = 'none');

            // è²·æ–¹åœ°å€
            if (poData.buyerAddress) {
                document.getElementById('valBuyerAddress').textContent = poData.buyerAddress.replace(/\n/g, ', ');
                document.getElementById('extraBuyerAddress').style.display = 'flex';
                hasExtraInfo = true;
            }
            if (poData.sellerAddress) {
                document.getElementById('valSellerAddress').textContent = poData.sellerAddress.replace(/\n/g, ', ');
                document.getElementById('extraSellerAddress').style.display = 'flex';
                hasExtraInfo = true;
            }

            // æ”¶è²¨åœ°å€
            if (poData.deliveryAddress) {
                document.getElementById('valDeliveryAddress').textContent = poData.deliveryAddress.replace(/\n/g, ', ');
                document.getElementById('extraDeliveryAddress').style.display = 'flex';
                hasExtraInfo = true;
            }

            // è¯çµ¡æ–¹å¼
            if (poData.contact) {
                document.getElementById('valContact').textContent = poData.contact;
                document.getElementById('extraContact').style.display = 'flex';
                hasExtraInfo = true;
            }

            // ä»˜æ¬¾æ¢ä»¶
            if (poData.paymentTerm) {
                document.getElementById('valPaymentTerm').textContent = poData.paymentTerm;
                document.getElementById('extraPaymentTerm').style.display = 'flex';
                hasExtraInfo = true;
            }

            // é…é€æ¢ä»¶
            if (poData.shippingTerm) {
                document.getElementById('valShippingTerm').textContent = poData.shippingTerm;
                document.getElementById('extraShippingTerm').style.display = 'flex';
                hasExtraInfo = true;
            }

            // å‚™è¨»
            if (poData.remarks) {
                document.getElementById('valRemarks').textContent = poData.remarks;
                document.getElementById('extraRemarks').style.display = 'flex';
                hasExtraInfo = true;
            }

            extraSection.style.display = hasExtraInfo ? 'block' : 'none';

            // å¦‚æœæ²’æœ‰é …ç›®ï¼Œåªé¡¯ç¤ºæ‘˜è¦
            if (!poData.items || poData.items.length === 0) {
                itemsContainer.innerHTML = '<div class="no-items-message">ğŸ“¦ å°šç„¡é …ç›®æ˜ç´°ï¼Œé»æ“Šä¸‹æ–¹ã€Œæ–°å¢é …ç›®ã€æŒ‰éˆ•</div>';
                tableContainer.style.display = 'block';
                return;
            }

            // æ¸…ç©ºå®¹å™¨
            itemsContainer.innerHTML = '';

            // å¡«å……é …ç›®å¡ç‰‡
            poData.items.forEach((item, index) => {
                const card = createItemCard(item, index);
                itemsContainer.appendChild(card);
            });

            // é¡¯ç¤ºè¡¨æ ¼å®¹å™¨
            tableContainer.style.display = 'block';
        }

        // å‰µå»ºé …ç›®å¡ç‰‡
        function createItemCard(item, index) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.index = index;

            const description = (item.description || '').replace(/\n/g, '\n');
            const amount = item.amount || 0;

            card.innerHTML = `
                <button class="item-delete-btn" onclick="deleteItem(${index})" title="åˆªé™¤æ­¤é …ç›®">âœ•</button>
                <div class="item-card-header">
                    <div class="item-line-no">${item.lineNo || index + 1}</div>
                    <div class="item-amount-display">${poData.currency || 'USD'} ${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="item-card-body">
                    <div class="item-field">
                        <span class="item-field-label">ç‰©å“ç·¨è™Ÿ</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="itemNo">${item.itemNo || '-'}</span>
                    </div>
                    <div class="item-field wide">
                        <span class="item-field-label">å“å/è¦æ ¼</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="description">${description || '-'}</span>
                    </div>
                    <div class="item-field">
                        <span class="item-field-label">æ¡è³¼æ•¸é‡</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="quantity">${(item.quantity || 0).toLocaleString()}</span>
                    </div>
                    <div class="item-field">
                        <span class="item-field-label">å–®ä½</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="unit">${item.unit || 'PCS'}</span>
                    </div>
                    <div class="item-field">
                        <span class="item-field-label">æ¡è³¼å–®åƒ¹</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="unitPrice">${(item.unitPrice || 0).toFixed(4)}</span>
                    </div>
                    <div class="item-field">
                        <span class="item-field-label">æ¡è³¼é‡‘é¡</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="amount">${amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="item-field">
                        <span class="item-field-label">é äº¤æ—¥</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="deliveryDate">${item.deliveryDate || '-'}</span>
                    </div>
                    <div class="item-field wide">
                        <span class="item-field-label">å‚™è¨»</span>
                        <span class="item-field-value" contenteditable="true" data-index="${index}" data-field="remarks">${item.remarks || '-'}</span>
                    </div>
                </div>
            `;

            // ç¶å®šç·¨è¼¯äº‹ä»¶
            card.querySelectorAll('.item-field-value[contenteditable="true"]').forEach(field => {
                field.addEventListener('blur', handleItemFieldEdit);
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });

            return card;
        }

        // è™•ç†é …ç›®æ¬„ä½ç·¨è¼¯
        function handleItemFieldEdit(e) {
            const field = e.target;
            const index = parseInt(field.dataset.index);
            const fieldName = field.dataset.field;
            let value = field.textContent.trim();

            if (poData && poData.items && poData.items[index]) {
                // æ•¸å€¼æ¬„ä½è½‰æ›
                if (['quantity', 'unitPrice', 'amount'].includes(fieldName)) {
                    const numMatch = value.match(/([\d,]+\.?\d*)/);
                    if (numMatch) {
                        value = parseFloat(numMatch[1].replace(/,/g, ''));
                    } else {
                        value = 0;
                    }
                }

                poData.items[index][fieldName] = value;
                console.log(`âœï¸ é …ç›® ${index + 1} çš„ ${fieldName} å·²æ›´æ–°ç‚º: ${value}`);

                // å¦‚æœä¿®æ”¹äº†æ•¸é‡æˆ–å–®åƒ¹ï¼Œè‡ªå‹•è¨ˆç®—é‡‘é¡
                if (fieldName === 'quantity' || fieldName === 'unitPrice') {
                    const qty = poData.items[index].quantity || 0;
                    const price = poData.items[index].unitPrice || 0;
                    poData.items[index].amount = qty * price;
                    
                    // æ›´æ–°å¡ç‰‡ä¸Šçš„é‡‘é¡é¡¯ç¤º
                    const card = field.closest('.item-card');
                    const amountDisplay = card.querySelector('.item-amount-display');
                    const amountField = card.querySelector('[data-field="amount"]');
                    if (amountDisplay) {
                        amountDisplay.textContent = `${poData.currency || 'USD'} ${poData.items[index].amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    }
                    if (amountField) {
                        amountField.textContent = poData.items[index].amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                }

                // æ›´æ–° JSON é è¦½
                document.getElementById('jsonPreview').textContent = JSON.stringify(poData, null, 2);
            }
        }

        // åˆªé™¤é …ç›®
        function deleteItem(index) {
            if (!poData || !poData.items) return;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é …ç›® ${index + 1} å—ï¼Ÿ`)) {
                poData.items.splice(index, 1);
                
                // é‡æ–°ç·¨è™Ÿ
                poData.items.forEach((item, i) => {
                    item.lineNo = i + 1;
                });

                // é‡æ–°æ¸²æŸ“
                renderDataTable();
                document.getElementById('jsonPreview').textContent = JSON.stringify(poData, null, 2);
                showMessage(`âœ… å·²åˆªé™¤é …ç›®`, 'success');
            }
        }

        // æ–°å¢é …ç›®
        function addNewItem() {
            if (!poData) {
                poData = {
                    poNo: '',
                    poDate: '',
                    buyer: '',
                    seller: '',
                    currency: 'USD',
                    totalAmount: 0,
                    deliveryDate: '',
                    items: []
                };
            }
            if (!poData.items) {
                poData.items = [];
            }

            const newItem = {
                lineNo: poData.items.length + 1,
                itemNo: '',
                description: '',
                quantity: 0,
                unit: 'PCS',
                unitPrice: 0,
                amount: 0,
                deliveryDate: '',
                remarks: ''
            };

            poData.items.push(newItem);
            renderDataTable();
            document.getElementById('jsonPreview').textContent = JSON.stringify(poData, null, 2);
            
            // æ»¾å‹•åˆ°æ–°é …ç›®
            const container = document.getElementById('itemsContainer');
            const lastCard = container.lastElementChild;
            if (lastCard) {
                lastCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // è‡ªå‹•èšç„¦åˆ°ç‰©å“ç·¨è™Ÿæ¬„ä½
                setTimeout(() => {
                    const firstField = lastCard.querySelector('.item-field-value[contenteditable="true"]');
                    if (firstField) firstField.focus();
                }, 300);
            }
            
            showMessage(`âœ… å·²æ–°å¢é …ç›® ${newItem.lineNo}`, 'success');
        }

        // æ ¼å¼é¸æ“‡
        function selectFormat(format) {
            selectedFormat = format;

            // æ›´æ–° UI
            document.getElementById('formatCO').classList.remove('selected');
            document.getElementById('formatSO').classList.remove('selected');
            document.getElementById('formatTWOSTAGE').classList.remove('selected');
            document.getElementById(`format${format}`).classList.add('selected');

            // å•Ÿç”¨ä¸‹è¼‰æŒ‰éˆ•
            document.getElementById('downloadBtn').disabled = false;

            const formatName = format === 'TWOSTAGE' ? 'å…©éšæ®µ' : format;
            showMessage(`å·²é¸æ“‡ ${formatName} æ ¼å¼`, 'info');
        }

        // ç¶å®šå¯ç·¨è¼¯æ¬„ä½çš„äº‹ä»¶ç›£è½
        function bindEditableFields() {
            const editableFields = document.querySelectorAll('.summary-value[contenteditable="true"]');
            editableFields.forEach(field => {
                field.addEventListener('blur', function() {
                    const fieldName = this.dataset.field;
                    let value = this.textContent.trim();
                    
                    if (poData && fieldName) {
                        // ç‰¹æ®Šè™•ç†ç¸½é‡‘é¡ï¼ˆç§»é™¤å¹£åˆ¥å’Œåƒåˆ†ä½ç¬¦è™Ÿï¼‰
                        if (fieldName === 'totalAmount') {
                            const numMatch = value.match(/([\d,]+\.?\d*)/);
                            if (numMatch) {
                                value = parseFloat(numMatch[1].replace(/,/g, ''));
                            }
                        }
                        
                        poData[fieldName] = value;
                        console.log(`âœï¸ å·²æ›´æ–° ${fieldName}: ${value}`);
                        
                        // æ›´æ–° JSON é è¦½
                        document.getElementById('jsonPreview').textContent = JSON.stringify(poData, null, 2);
                    }
                });

                // æŒ‰ Enter éµæ™‚å¤±å»ç„¦é»
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        // åˆå§‹åŒ–å¯ç·¨è¼¯æ¬„ä½
        document.addEventListener('DOMContentLoaded', bindEditableFields);

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const msg = document.getElementById('progressMessage');
            msg.textContent = message;
            msg.className = `progress-message ${type} show`;
            
            if (type === 'success') {
                setTimeout(() => msg.classList.remove('show'), 3000);
            }
        }

        // ä¸‹è¼‰ Excel
        async function downloadExcel() {
            if (!poData) {
                showMessage('âŒ è«‹å…ˆè¼‰å…¥ JSON è³‡æ–™', 'error');
                return;
            }

            if (!selectedFormat) {
                showMessage('âŒ è«‹å…ˆé¸æ“‡è¼¸å‡ºæ ¼å¼', 'error');
                return;
            }

            try {
                const formatName = selectedFormat === 'TWOSTAGE' ? 'å…©éšæ®µ' : selectedFormat;
                showMessage(`â³ æ­£åœ¨ç”Ÿæˆ ${formatName} Excel æª”æ¡ˆ...`, 'info');

                const response = await fetch('https://wk-pdf-ocr.azurewebsites.net/api/convert-po-to-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        poJson: JSON.stringify(poData),
                        format: selectedFormat,
                        paramValue: document.getElementById('paramValue').value || 'AUTO'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }

                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = await response.blob();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `PO_${selectedFormat}_${timestamp}.xlsx`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

                showMessage(`âœ… Excel æª”æ¡ˆå·²ä¸‹è¼‰: ${filename}`, 'success');
            } catch (error) {
                showMessage(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
                console.error('ä¸‹è¼‰éŒ¯èª¤:', error);
            }
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            selectedFormat = null;
            poData = null;
            document.getElementById('formatCO').classList.remove('selected');
            document.getElementById('formatSO').classList.remove('selected');
            document.getElementById('formatTWOSTAGE').classList.remove('selected');
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('paramValue').value = 'AUTO';
            document.getElementById('jsonPreview').textContent = 'ç­‰å¾… JSON è³‡æ–™...';
            document.getElementById('progressMessage').classList.remove('show');
            document.getElementById('tableContainer').style.display = 'none';
        }

        // æ”¯æ´è²¼ä¸Š JSON
        document.addEventListener('paste', (e) => {
            try {
                const text = e.clipboardData.getData('text');
                const json = JSON.parse(text);
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯ Azure OCR åŸå§‹çµæœ
                if (json.pages) {
                    const parsed = parseOCRRawResult(json);
                    if (parsed) {
                        poData = parsed;
                        document.getElementById('jsonPreview').textContent = JSON.stringify(parsed, null, 2);
                        renderDataTable();
                        showMessage('âœ… OCR çµæœå·²è½‰æ›ç‚ºçµæ§‹åŒ–æ ¼å¼', 'success');
                        console.log('ğŸ“¥ è½‰æ›å¾Œçš„æ•¸æ“š:', parsed);
                    }
                } else if (json.items) {
                    // å·²æ˜¯çµæ§‹åŒ–æ ¼å¼
                    poData = json;
                    document.getElementById('jsonPreview').textContent = JSON.stringify(json, null, 2);
                    renderDataTable();
                    showMessage('âœ… JSON è³‡æ–™å·²è²¼ä¸Š', 'success');
                }
            } catch (err) {
                console.error('è§£æå¤±æ•—:', err);
                // å¿½ç•¥é JSON æ–‡æœ¬
            }
        });

        // é¡¯ç¤ºè¾¨è­˜ç‡
        function displayConfidence(confidence) {
            if (!confidence) {
                console.log('âš ï¸ æ²’æœ‰ä¿¡è³´åº¦è³‡è¨Š');
                return;
            }
            
            const display = document.getElementById('confidenceDisplay');
            const valueEl = document.getElementById('confidenceValue');
            const detailsEl = document.getElementById('confidenceDetails');
            
            // é¸æ“‡æœ€ä½³è¾¨è­˜ç‡
            const mainConfidence = confidence.averagePageConfidence || 
                                   confidence.overall || 
                                   confidence.document || 
                                   confidence.averageFieldConfidence;
            
            if (mainConfidence !== null && mainConfidence !== undefined) {
                // é¡¯ç¤ºä¸»è¦è¾¨è­˜ç‡
                const formattedValue = Number(mainConfidence).toFixed(1) + '%';
                valueEl.textContent = formattedValue;
                
                // æ ¹æ“šæ•¸å€¼è¨­å®šé¡è‰²ç­‰ç´š
                valueEl.classList.remove('high', 'medium', 'low');
                if (mainConfidence >= 90) {
                    valueEl.classList.add('high');
                } else if (mainConfidence >= 70) {
                    valueEl.classList.add('medium');
                } else {
                    valueEl.classList.add('low');
                }
                
                // é¡¯ç¤ºè©³ç´°è³‡è¨Š
                let detailsHTML = '';
                if (confidence.document !== null && confidence.document !== undefined) {
                    detailsHTML += `<span class="confidence-detail-item">ğŸ“„ æ–‡ä»¶: ${Number(confidence.document).toFixed(1)}%</span>`;
                }
                if (confidence.averagePageConfidence !== null && confidence.averagePageConfidence !== undefined) {
                    detailsHTML += `<span class="confidence-detail-item">ğŸ“– é é¢: ${Number(confidence.averagePageConfidence).toFixed(1)}%</span>`;
                }
                if (confidence.averageFieldConfidence !== null && confidence.averageFieldConfidence !== undefined) {
                    detailsHTML += `<span class="confidence-detail-item">ğŸ”¤ æ¬„ä½: ${Number(confidence.averageFieldConfidence).toFixed(1)}%</span>`;
                }
                detailsEl.innerHTML = detailsHTML;
                
                // é¡¯ç¤ºå€å¡Š
                display.style.display = 'block';
                console.log('ğŸ“Š é¡¯ç¤ºè¾¨è­˜ç‡:', mainConfidence.toFixed(1) + '%', confidence);
            }
        }

        // é é¢åŠ è¼‰æ™‚æª¢æŸ¥ localStorage ä¸­çš„ OCR è³‡æ–™
        window.addEventListener('load', () => {
            // å„ªå…ˆå¾ localStorage è®€å– OCR è¾¨è­˜çµæœï¼ˆæ”¯æŒå¤šå€‹éµå€¼ï¼‰
            const savedOCR = localStorage.getItem('ocrResult') || localStorage.getItem('poOcrResult');
            if (savedOCR) {
                try {
                    const rawData = JSON.parse(savedOCR);
                    
                    // è‡ªå‹•è½‰æ› Azure OCR æ ¼å¼ï¼ˆå¦‚æœæ˜¯åŸå§‹ OCR å›æ‡‰ï¼‰
                    let processedData = rawData;
                    if (rawData.pages && rawData.tables) {
                        // é€™æ˜¯ Azure OCR åŸå§‹æ ¼å¼
                        processedData = parseOCRRawResult(rawData);
                    } else if (rawData.poNo || rawData.purchaseOrder || rawData.buyer || rawData.items) {
                        // é€™å·²ç¶“æ˜¯çµæ§‹åŒ–æ ¼å¼ï¼Œç¢ºä¿æœ‰ poNo æ¬„ä½
                        processedData = {
                            poNo: rawData.poNo || rawData.purchaseOrder || '',
                            poDate: rawData.poDate || rawData.date || '',
                            buyer: rawData.buyer || '',
                            seller: rawData.seller || '',
                            sellerAddress: rawData.sellerAddress || '',
                            buyerAddress: rawData.buyerAddress || '',
                            deliveryAddress: rawData.deliveryAddress || rawData.buyerAddress || '',
                            contact: rawData.contact || '',
                            paymentTerm: rawData.paymentTerm || '',
                            totalAmount: rawData.totalAmount || 0,
                            currency: rawData.currency || 'USD',
                            deliveryDate: rawData.deliveryDate || '',
                            remarks: rawData.remarks || '',
                            items: (rawData.items || []).map(item => ({
                                lineNo: item.lineNo || item.itemNo,
                                itemNo: item.itemNo || '',
                                description: item.description || '',
                                quantity: item.quantity || 0,
                                unit: item.unit || 'PCS',
                                unitPrice: item.unitPrice || 0,
                                amount: item.amount || 0,
                                deliveryDate: item.deliveryDate || item.date || '',
                                remarks: item.remarks || ''
                            }))
                        };
                    } else if (rawData.invoiceNo) {
                        // é€™æ˜¯ä¾†è‡ªç™¼ç¥¨çš„è³‡æ–™ï¼Œè½‰æ›ç‚ºæ¡è³¼å–®æ ¼å¼
                        processedData = {
                            poNo: rawData.invoiceNo || '',
                            poDate: rawData.date || '',
                            buyer: rawData.buyer || '',
                            seller: rawData.seller || '',
                            sellerAddress: rawData.sellerAddress || '',
                            buyerAddress: rawData.buyerAddress || '',
                            deliveryAddress: rawData.buyerAddress || '',
                            contact: rawData.contact || '',
                            paymentTerm: rawData.paymentTerm || '',
                            totalAmount: rawData.totalAmount || 0,
                            currency: rawData.currency || 'USD',
                            deliveryDate: '',
                            remarks: '',
                            items: (rawData.items || []).map(item => ({
                                lineNo: item.lineNo || item.itemNo,
                                itemNo: item.itemNo || '',
                                description: item.description || '',
                                quantity: item.quantity || 0,
                                unit: item.unit || 'PCS',
                                unitPrice: item.unitPrice || 0,
                                amount: item.amount || 0,
                                deliveryDate: item.deliveryDate || '',
                                remarks: item.remarks || ''
                            }))
                        };
                    }

                    if (processedData && (processedData.poNo || processedData.buyer || processedData.items)) {
                        poData = processedData;
                        document.getElementById('jsonPreview').textContent = JSON.stringify(processedData, null, 2);
                        renderDataTable();
                        showMessage('âœ… å·²è‡ªå‹•è¼‰å…¥ OCR è¾¨è­˜çµæœ', 'success');
                        console.log('ğŸ“¥ å¾ localStorage è¼‰å…¥ OCR è³‡æ–™:', processedData);
                        
                        // é¡¯ç¤ºè¾¨è­˜ç‡
                        if (rawData.confidence) {
                            displayConfidence(rawData.confidence);
                        }
                    } else {
                        console.warn('âš ï¸ è³‡æ–™æ ¼å¼ä¸åŒ¹é…ï¼Œç„¡æ³•è§£æ');
                    }
                    
                    // æ¸…é™¤ localStorage ä¸­çš„è³‡æ–™ï¼ˆé¿å…é‡è¤‡ä½¿ç”¨ï¼‰
                    localStorage.removeItem('ocrResult');
                    localStorage.removeItem('poOcrResult');
                } catch (err) {
                    console.error('âŒ è¼‰å…¥ localStorage è³‡æ–™å¤±æ•—:', err);
                    showMessage('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—: ' + err.message, 'error');
                }
            }
        });
    </script>
</body>
</html>
