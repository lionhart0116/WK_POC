<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ–‡ä»¶è™•ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* é é¢æ¨™é¡Œ */
        .page-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .steps-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: white;
            color: #667eea;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #4caf50;
            color: white;
        }

        .step-label {
            color: white;
            font-size: 14px;
            opacity: 0.7;
        }

        .step.active .step-label {
            opacity: 1;
            font-weight: 600;
        }

        .step-arrow {
            color: white;
            opacity: 0.5;
            font-size: 20px;
        }

        /* ä¸»è¦å…§å®¹å¡ç‰‡ */
        .main-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 25px;
            min-height: auto;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ + ä¸Šå‚³ ===== */
        .layer-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
        }

        .type-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 700px;
            margin: 0 auto 40px;
        }

        .type-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .type-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .type-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .type-card h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }

        .type-card p {
            font-size: 13px;
            opacity: 0.8;
        }

        .format-tags {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .format-tag {
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 500;
        }

        .type-card.selected .format-tag {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ä¸Šå‚³å€åŸŸ */
        .upload-section {
            max-width: 700px;
            margin: 0 auto;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        .upload-zone {
            border: 3px dashed #d0d0d0;
            border-radius: 16px;
            padding: 50px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f5f6ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e8eaff;
            transform: scale(1.02);
        }

        .upload-zone.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }

        .upload-zone h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-zone p {
            color: #666;
            font-size: 14px;
        }

        .file-info {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-info .icon {
            font-size: 40px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .file-size {
            font-size: 13px;
            color: #666;
        }

        .remove-file-btn {
            background: #ff5252;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .remove-file-btn:hover {
            background: #ff1744;
        }

        /* ===== ç¬¬äºŒå±¤ï¼šOCR çµæœ ===== */
        .ocr-result-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .result-header {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .result-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-header .icon {
            font-size: 28px;
        }

        .result-header h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .result-header p {
            font-size: 11px;
            opacity: 0.9;
        }

        .confidence-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .ocr-data-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: white;
            border-radius: 8px;
        }

        .data-label {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .data-value {
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .warning-box .icon {
            font-size: 24px;
        }

        .warning-box p {
            color: #856404;
            font-size: 14px;
            margin: 0;
        }

        /* ===== ç¬¬ä¸‰å±¤ï¼šæ ¼å¼é¸æ“‡ ===== */
        .format-selection-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .selected-data-summary {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .selected-data-summary h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .format-selection-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .format-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .format-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .format-option .icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .format-option h4 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .format-option p {
            font-size: 13px;
            opacity: 0.8;
        }

        /* æŒ‰éˆ• */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* JSON æª¢è¦–å™¨ */
        .json-viewer-section {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .json-viewer-header {
            background: #333;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .json-viewer-header h4 {
            margin: 0;
            font-size: 12px;
            font-weight: 600;
        }

        .toggle-btn {
            background: #555;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .toggle-btn:hover {
            background: #777;
        }

        /* JSON æª¢è¦–å™¨æ¨™ç±¤é æ¨£å¼ */
        .json-view-tabs {
            display: flex;
            gap: 8px;
        }

        .json-tab {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 6px 12px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            color: #666;
        }

        .json-tab:hover {
            background: #e0e0e0;
        }

        .json-tab.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }

        .json-viewer-container {
            max-height: 280px;
            overflow-y: auto;
            background: #2d2d2d;
            padding: 10px;
            font-family: 'Courier New', monospace;
        }

        .json-content {
            margin: 0;
            color: #4ec9b0;
            font-size: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .copy-btn.copied {
            background: #2196f3;
        }

        /* è™•ç†ä¸­å‹•ç•« */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }

        .processing-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 6px solid #f0f0f0;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .processing-detail {
            font-size: 14px;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .type-selection {
                grid-template-columns: 1fr;
            }

            .data-grid, .summary-grid {
                grid-template-columns: 1fr;
            }

            .format-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
            <h1>ğŸ¤– æ™ºæ…§æ–‡ä»¶è™•ç†ç³»çµ±</h1>
            <p>Powered by Copilot Studio & Azure OpenAI</p>
        </div>

        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="steps-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">é¸æ“‡é¡å‹ä¸¦ä¸Šå‚³</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">ç¢ºèª OCR çµæœ</div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å¡ç‰‡ -->
        <div class="main-card">
            <!-- ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ + ä¸Šå‚³ ===== -->
            <div id="layer1">
                <h2 class="layer-title">é¸æ“‡æ–‡ä»¶é¡å‹ä¸¦ä¸Šå‚³</h2>
                
                <div class="type-selection">
                    <div class="type-card" id="invoiceCard" onclick="selectType('invoice')">
                        <div class="type-icon">ğŸ“„</div>
                        <h3>ç™¼ç¥¨</h3>
                        <p>è‡ªå‹•è¾¨è­˜ç™¼ç¥¨å…§å®¹</p>
                        <div class="format-tags">
                            <span class="format-tag">406INF.xlsx</span>
                            <span class="format-tag">407INF.csv</span>
                        </div>
                    </div>

                    <div class="type-card" id="orderCard" onclick="selectType('order')">
                        <div class="type-icon">ğŸ›’</div>
                        <h3>è¨‚å–®</h3>
                        <p>è­˜åˆ¥è¨‚å–®è³‡è¨Š</p>
                        <div class="format-tags">
                            <span class="format-tag">CO.csv</span>
                            <span class="format-tag">SO.csv</span>
                            <span class="format-tag">å…©éšæ®µ.csv</span>
                        </div>
                    </div>
                </div>

                <div class="upload-section" id="uploadSection">
                    <div id="uploadArea">
                        <div class="upload-zone disabled" id="uploadZone">
                            <div class="upload-icon">ğŸ“</div>
                            <h3>è«‹å…ˆé¸æ“‡æ–‡ä»¶é¡å‹</h3>
                            <p>é¸æ“‡ä¸Šæ–¹çš„ç™¼ç¥¨æˆ–è¨‚å–®å¾Œå³å¯ä¸Šå‚³</p>
                        </div>
                    </div>

                    <div id="fileInfoArea" class="hidden">
                        <div class="file-info">
                            <div class="icon">ğŸ“„</div>
                            <div class="file-details">
                                <div class="file-name" id="fileName"></div>
                                <div class="file-size" id="fileSize"></div>
                            </div>
                            <button class="remove-file-btn" onclick="removeFile()">ç§»é™¤</button>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="resetToStart()">é‡æ–°é¸æ“‡</button>
                            <button class="btn btn-primary" onclick="startOCR()">é–‹å§‹è¾¨è­˜</button>
                        </div>
                    </div>
                </div>

                <input type="file" id="fileInput" accept=".pdf" onchange="handleFileUpload(event)">
            </div>

            <!-- ===== ç¬¬äºŒå±¤ï¼šOCR çµæœ ===== -->
            <div id="layer2" class="hidden">
                <div class="ocr-result-section">
                    <div class="result-header">
                        <div class="result-header-left">
                            <div class="icon">âœ…</div>
                            <div>
                                <h3>OCR è¾¨è­˜å®Œæˆ</h3>
                                <p>æ–‡ä»¶å·²æˆåŠŸè¾¨è­˜ä¸¦çµæ§‹åŒ–</p>
                            </div>
                        </div>
                        <div class="confidence-badge" id="confidenceBadge">
                            ä¿¡è³´åº¦: 95%
                        </div>
                    </div>

                    <!-- JSON æª¢è¦–å™¨ -->
                    <div class="json-viewer-section">
                        <div class="json-viewer-header">
                            <h4 style="margin: 0;">ğŸ“‹ å®Œæ•´ JSON å›æ‡‰</h4>
                            <button class="copy-btn" id="copyJsonBtn" onclick="copyJSONToClipboard()">ğŸ“‹ è¤‡è£½</button>
                        </div>
                        <div id="jsonViewerContainer" class="json-viewer-container">
                            <pre id="jsonContent" class="json-content"></pre>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="resetToStart()">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="confirmOCR()">âœ“ ç¢ºèªä¸¦ç¹¼çºŒ</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- è™•ç†ä¸­å‹•ç•« -->
    <div id="processingOverlay" class="processing-overlay hidden">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text" id="processingText">æ­£åœ¨è™•ç†...</div>
            <div class="processing-detail" id="processingDetail"></div>
        </div>
    </div>

    <script>
        // ===== Azure Function é…ç½® =====
        // æ–°ç‰ˆæœ¬ä½¿ç”¨å®˜æ–¹ SDK (æ¨è–¦)
        const AZURE_FUNCTION_URL_SDK = 'https://wk-pdf-ocr.azurewebsites.net/api/upload-ocr-sdk';
        // èˆŠç‰ˆæœ¬ä½¿ç”¨ç›´æ¥ REST èª¿ç”¨ (å·²æ£„ç”¨)
        const AZURE_FUNCTION_URL_LEGACY = 'https://wk-pdf-ocr.azurewebsites.net/api/upload-ocr';
        
        // ä½¿ç”¨ SDK ç‰ˆæœ¬ï¼ˆæ¨è–¦ï¼‰
        const AZURE_FUNCTION_URL = AZURE_FUNCTION_URL_SDK;
        const AZURE_FUNCTION_KEY = 'WroYmVpW907kYgMrRNkhwcHjBH42Hl7DZ9K1-3YszFUwAzFu1iAZNw==';

        // å…¨å±€è®Šæ•¸
        let selectedType = null;
        let uploadedFile = null;
        let selectedFormat = null;
        let ocrData = null;

        // é¡å‹é…ç½®
        const typeConfig = {
            invoice: {
                icon: 'ğŸ“„',
                name: 'ç™¼ç¥¨',
                formats: [
                    { id: '406', name: '406 æ ¼å¼', desc: 'Excel æ ¼å¼è¼¸å‡º', icon: 'ğŸ“Š', ext: '.xlsx' },
                    { id: '407', name: '407 æ ¼å¼', desc: 'CSV æ ¼å¼è¼¸å‡º', icon: 'ğŸ“‹', ext: '.csv' }
                ],
                sampleData: {
                    'ç™¼ç¥¨è™Ÿç¢¼': 'AB-12345678',
                    'ç™¼ç¥¨æ—¥æœŸ': '2025-11-15',
                    'å®¢æˆ¶åç¨±': 'YGC èƒ½æºææ–™è‚¡ä»½æœ‰é™å…¬å¸',
                    'çµ±ä¸€ç·¨è™Ÿ': '12345678',
                    'å“é …': 'é‘„éµç®¡ä»¶é…ä»¶',
                    'æ•¸é‡': '500 ä»¶',
                    'æœªç¨…é‡‘é¡': 'NT$ 15,800',
                    'ç¨…é¡': 'NT$ 790',
                    'ç¸½è¨ˆ': 'NT$ 16,590',
                    'ç‹€æ…‹': 'âœ… å·²é–‹ç«‹'
                }
            },
            order: {
                icon: 'ğŸ›’',
                name: 'è¨‚å–®',
                formats: [
                    { id: 'CO', name: 'CO æ ¼å¼', desc: 'å®¢æˆ¶è¨‚å–®æ ¼å¼', icon: 'ğŸ“¦', ext: '.csv' },
                    { id: 'SO', name: 'SO æ ¼å¼', desc: 'éŠ·å”®è¨‚å–®æ ¼å¼', icon: 'ğŸ›ï¸', ext: '.csv' },
                    { id: 'TWO_STAGE', name: 'å…©éšæ®µæ ¼å¼', desc: 'å…©éšæ®µè™•ç†æ ¼å¼', icon: 'âš™ï¸', ext: '.csv' }
                ],
                sampleData: {
                    'è¨‚å–®ç·¨è™Ÿ': 'ORD-2025110001',
                    'è¨‚å–®æ—¥æœŸ': '2025-11-01',
                    'å®¢æˆ¶ä»£ç¢¼': 'C001',
                    'å®¢æˆ¶åç¨±': 'YGC èƒ½æºææ–™',
                    'ç”¢å“ä»£ç¢¼': 'P-CI-001',
                    'ç”¢å“åç¨±': 'é‘„éµç®¡ä»¶',
                    'æ•¸é‡': '500 ä»¶',
                    'å–®åƒ¹': 'NT$ 180',
                    'ç¸½é‡‘é¡': 'NT$ 90,000',
                    'äº¤æœŸ': '2025-11-25'
                }
            }
        };

        // ===== ç¬¬ä¸€å±¤ï¼šé¸æ“‡é¡å‹ =====
        function selectType(type) {
            selectedType = type;
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.getElementById('invoiceCard').classList.remove('selected');
            document.getElementById('orderCard').classList.remove('selected');
            document.getElementById(type + 'Card').classList.add('selected');
            
            // å•Ÿç”¨ä¸Šå‚³å€åŸŸ
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.remove('disabled');
            uploadZone.onclick = () => document.getElementById('fileInput').click();
            uploadZone.querySelector('h3').textContent = 'ä¸Šå‚³ PDF æ–‡ä»¶';
            uploadZone.querySelector('p').textContent = 'é»æ“Šæˆ–æ‹–æ”¾ PDF æ–‡ä»¶åˆ°æ­¤è™• (æœ€å¤§ 10MB)';
        }

        // æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!uploadZone.classList.contains('disabled')) {
                uploadZone.classList.add('dragover');
            }
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (!uploadZone.classList.contains('disabled')) {
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0]);
                }
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            uploadedFile = file;
            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2);
            
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileSize').textContent = `æª”æ¡ˆå¤§å°: ${fileSize} KB`;
            
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('fileInfoArea').classList.remove('hidden');
        }

        function removeFile() {
            uploadedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfoArea').classList.add('hidden');
        }

        // ===== ç¬¬äºŒå±¤ï¼šOCR è™•ç†èˆ‡çµæœ =====
        async function startOCR() {
            if (!uploadedFile) {
                alert('è«‹å…ˆä¸Šå‚³æª”æ¡ˆï¼');
                return;
            }
            
            showProcessing('æ­£åœ¨ä¸Šå‚³æ–‡ä»¶...', 'Azure Function è™•ç†ä¸­');
            
            try {
                // å»ºç«‹ FormData
                const formData = new FormData();
                formData.append('file', uploadedFile);

                // å‘¼å« Azure Function
                updateProcessing('æ­£åœ¨é€²è¡Œ OCR è¾¨è­˜...', 'Azure Computer Vision åˆ†æä¸­');
                
                const response = await fetch(`${AZURE_FUNCTION_URL}?code=${AZURE_FUNCTION_KEY}`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateProcessing('æ­£åœ¨çµæ§‹åŒ–è³‡æ–™...', 'è§£æ OCR çµæœ');
                
                const result = await response.json();
                console.log('OCR Result:', result);
                
                // æª¢æŸ¥çµæœæ ¼å¼
                // æ–°æ ¼å¼ï¼š{ meta, extracted, fullText, raw }
                // èˆŠæ ¼å¼ï¼š{ status, analyzeResult, ... }
                const isNewFormat = result.meta && result.extracted && typeof result.fullText === 'string';
                const isOldFormat = result.status === 'succeeded' || result.analyzeResult;
                
                if (!isNewFormat && !isOldFormat) {
                    throw new Error(`ä¸æ”¯æ´çš„ OCR çµæœæ ¼å¼: ${JSON.stringify(Object.keys(result))}`);
                }
                
                // å¦‚æœæ˜¯èˆŠæ ¼å¼ä¸”ç‹€æ…‹ä¸æ˜¯ succeededï¼Œæ‹‹å‡ºéŒ¯èª¤
                if (isOldFormat && result.status && result.status !== 'succeeded') {
                    throw new Error(`OCR è¾¨è­˜ç‹€æ…‹: ${result.status}`);
                }
                
                // å„²å­˜çµæœåˆ° localStorage
                const storageData = isNewFormat ? result : {
                    meta: { timestamp: new Date().toISOString() },
                    extracted: {},
                    fullText: '',
                    raw: result.analyzeResult,
                    analyzeResult: result.analyzeResult
                };
                
                storageData.fileName = uploadedFile.name;
                storageData.fileSize = uploadedFile.size;
                storageData.timestamp = new Date().toISOString();
                
                localStorage.setItem('ocrResult', JSON.stringify(storageData));
                console.log('âœ… çµæœå·²å­˜å„²åˆ° localStorage:', storageData);
                
                // è§£æ OCR çµæœï¼ˆç”¨æ–¼ç•¶å‰é é¢é¡¯ç¤ºï¼‰
                parseOCRResult(result);
                
                hideProcessing();
                showOCRResults();
                
            } catch (error) {
                hideProcessing();
                console.error('âŒ OCR éŒ¯èª¤è©³æƒ…:', error);
                console.error('éŒ¯èª¤å †æ£§:', error.stack);
                console.error('ocrData ç‹€æ…‹:', ocrData);
                
                let errorMsg = `OCR è¾¨è­˜å¤±æ•—ï¼š${error.message}\n\n`;
                errorMsg += `è©³ç´°è³‡è¨Šï¼š${error.toString()}\n\n`;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'å¯èƒ½åŸå› ï¼š\n';
                    errorMsg += '1. ç¶²è·¯é€£ç·šå•é¡Œ\n';
                    errorMsg += '2. Azure Function ç«¯é»ç„¡æ³•é€£æ¥\n';
                    errorMsg += '3. CORS è¨­å®šå•é¡Œ\n';
                    errorMsg += '4. Function Key å¯èƒ½å·²éæœŸ\n\n';
                    errorMsg += 'å»ºè­°ï¼šè«‹æª¢æŸ¥ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Console å’Œ Network æ¨™ç±¤';
                } else if (error.message.includes('HTTP')) {
                    errorMsg += 'ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤\n';
                    errorMsg += 'è«‹æª¢æŸ¥ Azure Function è¨­å®šå’Œ Computer Vision æœå‹™';
                } else if (error.message.includes('Cannot read')) {
                    errorMsg += 'è³‡æ–™æ ¼å¼éŒ¯èª¤\n';
                    errorMsg += 'è«‹æª¢æŸ¥ Azure Function è¿”å›çš„æ•¸æ“šçµæ§‹';
                }
                
                console.error(errorMsg);
                alert(errorMsg);
            }
        }
        
        // è§£æ OCR çµæœ
        function parseOCRResult(result) {
            console.log('ğŸ“Š é–‹å§‹è§£æ OCR çµæœ:', result);
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼ï¼ˆAzure Document Intelligence SDK è¿”å›æ ¼å¼ï¼‰
            // æ ¼å¼ 1ï¼š{ status, pages, tables }
            if (result.status === 'succeeded' && result.pages && Array.isArray(result.pages)) {
                console.log('âœ… åµæ¸¬åˆ° Azure SDK æ ¼å¼');
                
                // å°‡ pages è½‰æ›ç‚º analyzeResult æ ¼å¼
                const analyzeResult = {
                    apiVersion: '2024-02-29-preview',
                    modelId: 'prebuilt-read',
                    status: result.status,
                    pages: result.pages,
                    tables: result.tables || [],
                    readResults: [
                        {
                            page: 1,
                            angle: 0,
                            width: 0,
                            height: 0,
                            lines: result.pages[0]?.lines || []
                        }
                    ],
                    content: result.pages.map(p => p.lines.map(l => l.text).join('\n')).join('\n\n')
                };
                
                // èª¿ç”¨èˆŠæ ¼å¼è§£æé‚è¼¯
                parseOCRResultAsOldFormat({ analyzeResult });
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼ï¼ˆå·²åœ¨ Azure Function ä¸­çµæ§‹åŒ–ï¼‰
            // æ–°æ ¼å¼ï¼š{ meta, extracted, fullText, raw }
            if (result.meta && result.extracted && typeof result.fullText === 'string') {
                console.log('âœ… åµæ¸¬åˆ°çµæ§‹åŒ–æ ¼å¼');
                // ä½¿ç”¨ Azure Function è¿”å›çš„çµæ§‹åŒ–è³‡æ–™
                ocrData = result.extracted;
                
                // ç¢ºä¿ items æ˜¯é™£åˆ—
                if (!Array.isArray(ocrData.items)) {
                    ocrData.items = [];
                    console.warn('âš ï¸ items æ¬„ä½ä¸æ˜¯é™£åˆ—ï¼Œå·²åˆå§‹åŒ–ç‚ºç©ºé™£åˆ—');
                }
                
                ocrData._raw = result.raw;
                ocrData._allText = result.fullText;
                ocrData._meta = result.meta;
                
                // ä¿å­˜ä¿¡è³´åº¦è³‡è¨Š
                if (result.meta.confidence) {
                    ocrData._confidence = result.meta.confidence;
                    console.log('ğŸ“Š ä¿¡è³´åº¦è³‡è¨Š:', result.meta.confidence);
                }
                
                console.log('âœ… çµæ§‹åŒ–æ ¼å¼è§£æå®Œæˆ:', {
                    invoiceNo: ocrData.invoiceNo,
                    seller: ocrData.seller,
                    itemCount: ocrData.items.length,
                    totalAmount: ocrData.totalAmount,
                    confidence: ocrData._confidence?.overall || 'N/A'
                });
                return;
            }
            
            // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œå˜—è©¦ä½œç‚ºèˆŠæ ¼å¼è™•ç†
            console.log('â„¹ï¸ ä½¿ç”¨èˆŠæ ¼å¼è§£æ...');
            parseOCRResultAsOldFormat(result);
        }
        
        // èˆŠæ ¼å¼è§£æé‚è¼¯ï¼ˆæå–åˆ°ç¨ç«‹å‡½æ•¸ï¼‰
        function parseOCRResultAsOldFormat(result) {
            // èˆŠæ ¼å¼ç›¸å®¹æ€§ï¼šå¦‚æœæ˜¯ Document Intelligence çš„åŸå§‹å›æ‡‰
            const lines = result.analyzeResult?.readResults?.[0]?.lines || [];
            
            // æå–æ‰€æœ‰æ–‡å­—è¡Œ
            const textLines = lines.map(line => line.text);
            
            // æ ¹æ“šæ–‡ä»¶é¡å‹è§£æä¸åŒæ¬„ä½
            if (selectedType === 'invoice') {
                ocrData = parseInvoiceData(textLines, lines);
            } else if (selectedType === 'order') {
                ocrData = parseOrderData(textLines, lines);
            }
            
            // å„²å­˜åŸå§‹ OCR çµæœä¾›åƒè€ƒ
            ocrData._raw = result;
            ocrData._allText = textLines.join('\n');
            
            // ===== æ–¹æ¡ˆ Aï¼šç²¾ç°¡æå– =====
            // å°‡è¤‡é›œçš„ Document Intelligence å›æ‡‰è½‰æ›æˆç°¡æ½”çš„çµæ§‹
            ocrData._simplified = extractSimplifiedData(result, selectedType);
            
            console.log('âœ… èˆŠæ ¼å¼è§£æå®Œæˆ:', {
                invoiceNo: ocrData.invoiceNo,
                seller: ocrData.seller,
                itemCount: ocrData.items ? ocrData.items.length : 0,
                totalAmount: ocrData.totalAmount
            });
        }
        
        // ã€æ–¹æ¡ˆ Aã€‘å¾ Document Intelligence å›æ‡‰æå–ç²¾ç°¡è³‡æ–™
        // å°‡é¾å¤§çš„ API å›æ‡‰è½‰æ›ç‚ºæ˜“æ–¼å­˜å„²å’Œä½¿ç”¨çš„æœ€å°åŒ–çµæ§‹
        function extractSimplifiedData(result, docType) {
            const analyzeResult = result.analyzeResult || {};
            const pages = analyzeResult.pages || [];
            const content = analyzeResult.content || '';
            
            // åŸºç¤å…ƒè³‡æ–™
            const simplified = {
                // å…ƒè³‡æ–™
                meta: {
                    apiVersion: analyzeResult.apiVersion,
                    model: analyzeResult.modelId,
                    pageCount: pages.length,
                    timestamp: new Date().toISOString()
                },
                
                // æ ¸å¿ƒæå–æ¬„ä½
                extracted: {},
                
                // åŸå§‹å…¨æ–‡ï¼ˆä¾›æœå°‹å’Œå‚™ä»½ï¼‰
                fullText: content
            };
            
            // æ ¹æ“šæ–‡ä»¶é¡å‹æå–å°æ‡‰çš„æ¬„ä½
            if (docType === 'invoice') {
                simplified.extracted = extractInvoiceFields(content, pages);
            } else if (docType === 'order') {
                simplified.extracted = extractOrderFields(content, pages);
            }
            
            return simplified;
        }
        
        // ã€æ”¹é€²ç‰ˆæ–¹æ¡ˆ A v3ã€‘å¾ç™¼ç¥¨æå–è©³ç´°æ¬„ä½ï¼ˆæ”¯æŒå¤šç¨®æ ¼å¼ï¼‰
        function extractInvoiceFields(fullText, pages) {
            const fields = {};
            const lines = fullText.split('\n');
            
            // ===== åŸºæœ¬è³‡è¨Š =====
            // Invoice Number - æ”¹é€²ï¼šæ”¯æŒå¤šç¨®æ ¼å¼
            let invoiceNo = null;
            
            // æ–¹æ³• 1: åŒ¹é… "Invoice No .:" æ¨™ç±¤å¾Œçš„å€¼
            let invoiceMatch = fullText.match(/Invoice\s*No\s*[:.]*\s*([A-Z0-9\-]+)/i);
            if (invoiceMatch) {
                invoiceNo = invoiceMatch[1].trim();
            }
            
            // æ–¹æ³• 2: å¦‚æœæœªæ‰¾åˆ°ï¼Œå˜—è©¦ç´”æ•¸å­—+å­—æ¯æ ¼å¼ (2020066251106A)
            if (!invoiceNo) {
                invoiceMatch = fullText.match(/(\d{10,14}[A-Z]{1,3})\b/);
                if (invoiceMatch) {
                    invoiceNo = invoiceMatch[1];
                }
            }
            
            // æ–¹æ³• 3: å˜—è©¦å…¶ä»–æ¨™ç±¤æ ¼å¼
            if (!invoiceNo) {
                invoiceMatch = fullText.match(/(?:INV\s*NO|INVOICE#)[\s:]*([A-Z0-9\-]+)/i);
                if (invoiceMatch) {
                    invoiceNo = invoiceMatch[1].trim();
                }
            }
            
            fields.invoiceNo = invoiceNo;
            
            // Date - æ”¹é€²ï¼šæ”¯æŒå¤šç¨®æ—¥æœŸæ ¼å¼
            let dateMatch = fullText.match(/DATE[\s:]*(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/i);
            if (!dateMatch) {
                dateMatch = fullText.match(/(?:INVOICE DATE)[\s:]*(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/i);
            }
            if (!dateMatch) {
                dateMatch = fullText.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/);
            }
            fields.date = dateMatch ? dateMatch[1] : null;
            
            // ===== ä¾›æ‡‰å•†å’Œè²·æ–¹ =====
            // Seller/Supplier - æ”¹é€²ï¼šåŒ¹é… GIGADEVICE æˆ–å…¶ä»–æ ¼å¼
            let sellerMatch = fullText.match(/^(.+?LIMITED.+)$/im) ||
                             fullText.match(/^([A-Z]+(?:\s+[A-Z]+)*(?:\s+(?:LIMITED|CO\.|INC|CORP|COMPANY))?)/m);
            fields.seller = sellerMatch ? sellerMatch[1].trim() : null;
            
            // Seller Address
            let addressMatch = fullText.match(/(?:^|\n)(B\/F\s+BLDG\s+[^\n]+|[A-Z\s]*ADDRESS[\s:]*\n\s*([^\n]+))/i);
            fields.sellerAddress = addressMatch ? addressMatch[0].replace(/^[\n]/, '').trim() : null;
            
            // Contact/Tel
            let telMatch = fullText.match(/(?:TEL|PHONE|CONTACT)[\s:]*([^\n]+)/i);
            fields.contact = telMatch ? telMatch[1].trim() : null;
            
            // Buyer/Customer - æ”¹é€²ï¼šæ”¯æŒä¸­æ–‡
            let buyerMatch = fullText.match(/(?:BILL TO|SHIP TO|BUYER|CUSTOMER)[\s:]*\n\s*([^\n]+)/i) ||
                            fullText.match(/å¨å¥(?:å¯¦æ¥­|å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸)/i);
            fields.buyer = buyerMatch ? (typeof buyerMatch[1] === 'string' ? buyerMatch[1].trim() : buyerMatch[0]) : null;
            
            // ===== äº¤æ˜“æ¢æ¬¾ =====
            // Trade Term
            let tradeTermMatch = fullText.match(/Trade\s+Term[\s:]*([^\n]+)/i);
            fields.tradeTerm = tradeTermMatch ? tradeTermMatch[1].trim() : null;
            
            // Origin/Country
            let originMatch = fullText.match(/(?:COO|ORIGIN|COUNTRY)[\s:]*([^\n]+)/i);
            fields.origin = originMatch ? originMatch[1].trim() : null;
            
            // ===== è¡¨æ ¼è¡Œé …ç›®ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ =====
            fields.items = extractInvoiceTableItems(pages, fullText);
            
            // ===== é‡‘é¡å’Œå¹£åˆ¥ =====
            // Total Amount - æ”¹é€²ï¼šæ”¯æŒå¤šç¨®æ ¼å¼
            let totalMatch = fullText.match(/(?:TOTAL|TOTAL:)[\s:]*([0-9,]+\.?\d*)/i) ||
                            fullText.match(/USD[\s:]*([0-9,]+\.?\d*)/i);
            if (totalMatch) {
                fields.totalAmount = parseFloat(totalMatch[1].replace(/,/g, ''));
            }
            
            // Currency - æ”¹é€²ï¼šå¾ USD: æ¨™ç±¤ä¸­æå–
            let currencyMatch = fullText.match(/(?:USD|CNY|HKD|EUR|JPY)(?:[\s:]|$)/i);
            fields.currency = currencyMatch ? currencyMatch[0].replace(/[\s:]/g, '').trim() : 'USD';
            
            console.log('[OCR] æå–çš„å­—æ®µ:', {
                invoiceNo: fields.invoiceNo,
                date: fields.date,
                seller: fields.seller,
                totalAmount: fields.totalAmount,
                currency: fields.currency,
                itemCount: fields.items ? fields.items.length : 0
            });
            
            return fields;
        }
        
        // æ”¹é€²ç‰ˆ v6ï¼šå¤šæ¨¡å¼å®¹éŒ¯æ©Ÿåˆ¶ (Standard + Alternative + Fallback)
        function extractInvoiceTableItems(pages, fullText) {
            // å˜—è©¦æ¨™æº–æ¨¡å¼ (è‹±æ–‡ç™¼ç¥¨)
            let items = extractInvoiceTableItemsStandard(pages, fullText);
            if (items) {
                console.log('[OCR] è¡¨æ ¼æå–æˆåŠŸ (æ¨™æº–æ¨¡å¼)');
                return items;
            }
            
            // è‹¥æ¨™æº–æ¨¡å¼å¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ¨¡å¼ (ä¸­æ–‡ç™¼ç¥¨ã€æ›¿ä»£æ¨™ç±¤)
            items = extractInvoiceTableItemsAlternative(pages, fullText);
            if (items) {
                console.log('[OCR] è¡¨æ ¼æå–æˆåŠŸ (å‚™ç”¨æ¨¡å¼)');
                return items;
            }
            
            // è‹¥ä»å¤±æ•—ï¼Œå˜—è©¦ç°¡åŒ–æ¨¡å¼ (ä½çµæ§‹ç™¼ç¥¨)
            items = extractTableItemsFromText(fullText);
            if (items) {
                console.log('[OCR] è¡¨æ ¼æå–æˆåŠŸ (ç°¡åŒ–æ¨¡å¼)');
                return items;
            }
            
            // æ‰€æœ‰æ¨¡å¼éƒ½å¤±æ•—ï¼Œå›å‚³ null
            console.warn('[OCR] ç„¡æ³•è‡ªå‹•è§£æè¡¨æ ¼ï¼Œå»ºè­°äººå·¥ä¸Šå‚³è³‡æ–™');
            return null;
        }
        
        // æ¨¡å¼ Aï¼šæ¨™æº–ç™¼ç¥¨ (æ”¹é€²ç‰ˆ v2 - æ”¯æŒè¡Œåˆ†éš”æ ¼å¼ï¼Œå®Œæ•´æå–æ‰€æœ‰é …ç›®)
        function extractInvoiceTableItemsStandard(pages, fullText) {
            const items = [];
            const allLines = fullText.split('\n');
            
            // æ‰¾åˆ°è¡¨æ ¼é–‹å§‹è¡Œï¼ˆåŒ…å« Item, Category, Cust. PO# ç­‰æ¨™é¡Œï¼‰
            let headerLineIdx = -1;
            for (let i = 0; i < allLines.length; i++) {
                const line = allLines[i].toUpperCase();
                if (line.includes('ITEM') && 
                    line.includes('CATEGORY') &&
                    line.includes('QUANTITY')) {
                    headerLineIdx = i;
                    break;
                }
            }
            
            if (headerLineIdx === -1) {
                console.log('[OCR] æ‰¾ä¸åˆ°è¡¨æ ¼æ¨™é¡Œè¡Œ');
                return null;
            }
            
            console.log(`[OCR] æ‰¾åˆ°è¡¨æ ¼æ¨™é¡Œåœ¨ç¬¬ ${headerLineIdx} è¡Œ`);
            
            // æ‰¾åˆ° TOTAL æ‰€åœ¨è¡Œï¼ˆè¡¨æ ¼çµæŸä½ç½®ï¼‰
            let totalLineIdx = -1;
            for (let i = headerLineIdx + 1; i < allLines.length; i++) {
                const line = allLines[i].toUpperCase();
                if (line.includes('TOTAL:') || line.trim() === 'TOTAL') {
                    totalLineIdx = i;
                    break;
                }
            }
            
            if (totalLineIdx === -1) {
                totalLineIdx = allLines.length;
            }
            
            console.log(`[OCR] è¡¨æ ¼çµæŸåœ¨ç¬¬ ${totalLineIdx} è¡Œ`);
            
            // å¾è¡¨é ­å¾Œé–‹å§‹è§£æè¡Œé …ç›®
            let i = headerLineIdx + 1;
            while (i < totalLineIdx) {
                const line = allLines[i].trim();
                
                // è·³éç©ºè¡Œ
                if (!line) {
                    i++;
                    continue;
                }
                
                // è¡Œé …ç›®æ‡‰è©²ä»¥æ•¸å­—é–‹é ­ï¼ˆItem No: 10, 20, 30 ç­‰ï¼‰
                const itemMatch = line.match(/^(\d{1,2})\s*$/);
                if (!itemMatch) {
                    i++;
                    continue;
                }
                
                const itemNo = itemMatch[1];
                let category = null;
                let poNo = null;
                let description = null;
                let quantity = null;
                let unitPrice = null;
                let amount = null;
                
                // æ”¶é›†æ­¤é …çš„æ‰€æœ‰æ•¸æ“šè¡Œï¼ˆç›´åˆ°é‡åˆ°ä¸‹ä¸€å€‹æ•¸å­—é–‹é ­çš„è¡Œï¼‰
                let j = i + 1;
                const itemData = [];
                
                while (j < totalLineIdx) {
                    const nextLine = allLines[j].trim();
                    
                    if (!nextLine) {
                        j++;
                        continue;
                    }
                    
                    // å¦‚æœé‡åˆ°ä¸‹ä¸€å€‹é …ç›®ï¼ˆä»¥æ•¸å­—é–‹é ­ï¼‰ï¼Œåœæ­¢æ”¶é›†æ­¤é …
                    if (/^\d{1,2}\s*$/.test(nextLine)) {
                        break;
                    }
                    
                    itemData.push(nextLine);
                    j++;
                }
                
                // è§£ææ”¶é›†çš„æ•¸æ“š
                for (const data of itemData) {
                    const upperData = data.toUpperCase();
                    const trimmed = data.trim();
                    
                    // Category (å¦‚ "Integrate Circuit")
                    if (!category && (upperData.includes('CIRCUIT') || upperData.includes('COMPONENT'))) {
                        category = trimmed;
                    }
                    // PO# (æ•¸å­—ï¼Œé€šå¸¸ 9 ä½)
                    else if (!poNo && /^\d{9}$/.test(trimmed.replace(/[^\d]/g, ''))) {
                        poNo = trimmed;
                    }
                    // Description (é€šå¸¸æ˜¯ GD25... æ ¼å¼)
                    else if (!description && /^[A-Z0-9]{5,}/.test(trimmed)) {
                        description = trimmed;
                    }
                    // Quantity (æ•¸å­—ï¼Œå¯èƒ½æœ‰é€—è™Ÿï¼Œé€šå¸¸æ˜¯å››ä½æ•¸ä»¥ä¸Š)
                    else if (!quantity && /^\d{1,3}(?:,\d{3})*$/.test(trimmed)) {
                        quantity = parseInt(trimmed.replace(/,/g, ''));
                    }
                    // Unit Price (å°æ•¸é»å¾Œ 6 ä½æˆ–æ›´å°‘çš„æ•¸å­—)
                    else if (!unitPrice && /^\d+\.\d{1,6}$/.test(trimmed)) {
                        unitPrice = parseFloat(trimmed);
                    }
                    // Amount (åŒ…å«å°æ•¸é»ï¼Œé€šå¸¸æ˜¯ä¸‰ä½æ•¸ä»¥ä¸Šçš„é‡‘é¡)
                    else if (!amount && /^\d+(?:,\d{3})*\.\d{2}$/.test(trimmed)) {
                        amount = parseFloat(trimmed.replace(/,/g, ''));
                    }
                }
                
                // å»ºç«‹é …ç›®ç‰©ä»¶
                const item = {
                    itemNo,
                    category,
                    poNo,
                    description,
                    quantity,
                    unitPrice,
                    amount
                };
                
                // å¦‚æœç¼ºå°‘é‡‘é¡ä½†æœ‰æ•¸é‡å’Œå–®åƒ¹ï¼Œè¨ˆç®—é‡‘é¡
                if (!item.amount && item.quantity && item.unitPrice) {
                    item.amount = parseFloat((item.quantity * item.unitPrice).toFixed(2));
                }
                
                items.push(item);
                console.log(`[OCR] è§£æé …ç›® ${itemNo}:`, item);
                
                i = j;
            }
            
            console.log(`[OCR] æ¨™æº–æ¨¡å¼å…±æå– ${items.length} å€‹é …ç›®`);
            return items.length > 0 ? items : null;
        }
        
        // æ¨¡å¼ Bï¼šå‚™ç”¨ç™¼ç¥¨ (ä¸­æ–‡æ¨™ç±¤ã€æ›¿ä»£é‚Šç•Œæ¨™è¨˜)
        function extractInvoiceTableItemsAlternative(pages, fullText) {
            const upperText = fullText.toUpperCase();
            const items = [];
            
            // æ”¯æ´å¤šç¨®é‚Šç•Œæ¨™è¨˜
            const startMarkers = ['QUANTITY', 'æ•°é‡', 'å“å', 'ITEMS', 'SKU', 'PART NUMBER'];
            const endMarkers = ['TOTAL', 'åˆè®¡', 'å°è®¡', 'SUBTOTAL', 'GRAND TOTAL', 'AMOUNT DUE'];
            
            let tableStart = -1;
            let tableEnd = -1;
            
            for (const marker of startMarkers) {
                tableStart = upperText.indexOf(marker.toUpperCase());
                if (tableStart !== -1) break;
            }
            
            for (const marker of endMarkers) {
                tableEnd = upperText.indexOf(marker.toUpperCase());
                if (tableEnd !== -1) break;
            }
            
            if (tableStart === -1 || tableEnd === -1) {
                return null;
            }
            
            const tableContent = fullText.substring(tableStart, tableEnd);
            const tableLines = tableContent.split('\n').filter(l => l.trim().length > 0);
            
            // ç°¡åŒ–çš„è¡Œè™Ÿåµæ¸¬ (æ”¯æ´ 001, 1, A ç­‰)
            let i = 1;
            while (i < tableLines.length) {
                const line = tableLines[i].trim();
                
                // æ”¯æ´æ›´å¤šæ ¼å¼çš„è¡Œè™Ÿï¼š1-99, 001-999, A-Z
                const lineNoMatch = line.match(/^([0-9A-Z]{1,3})\s+(.+)/);
                if (!lineNoMatch || isNaN(parseInt(lineNoMatch[1])) && !/^[A-Z]$/.test(lineNoMatch[1])) {
                    i++;
                    continue;
                }
                
                const lineNo = lineNoMatch[1];
                const lineRest = lineNoMatch[2];
                
                const item = {
                    lineNo,
                    quantity: null,
                    unit: null,
                    itemNo: null,
                    description: null,
                    unitPrice: null,
                    amount: null,
                    poNo: null
                };
                
                // æ”¯æ´æ›´å¤šå–®ä½é¡å‹
                const qtyMatch = lineRest.match(/(\d+)\s+(PCS|EA|BOX|CASE|KG|M|PACK|UNITS?|SET|LOT|ROLL|ä»¶|å¥—|å·|å¼µ|ä¸ª|åª)/i);
                if (qtyMatch) {
                    item.quantity = parseInt(qtyMatch[1]);
                    item.unit = qtyMatch[2];
                }
                
                let j = i + 1;
                const itemLines = [];
                
                while (j < tableLines.length && !/^([0-9A-Z]{1,3})\s+/.test(tableLines[j].trim())) {
                    itemLines.push(tableLines[j].trim());
                    j++;
                }
                
                let textFieldCount = 0;
                for (const iline of itemLines) {
                    const trimmed = iline.trim();
                    const isNumeric = /^[\d,\.]+$/.test(trimmed);
                    
                    if (isNumeric) {
                        const num = parseFloat(trimmed.replace(/,/g, ''));
                        if (num < 1000 && num > 0.1 && !item.unitPrice) {
                            item.unitPrice = num;
                        } else if (num >= 1000 && num < 10000000 && !item.amount) {
                            item.amount = num;
                        }
                    } else if (trimmed.length > 0) {
                        if (textFieldCount === 0) {
                            item.itemNo = trimmed;
                            textFieldCount++;
                        } else if (textFieldCount === 1) {
                            item.description = trimmed;
                            textFieldCount++;
                        }
                    }
                }
                
                if (!item.amount && item.quantity && item.unitPrice) {
                    item.amount = parseFloat((item.quantity * item.unitPrice).toFixed(2));
                }
                
                items.push(item);
                i = j;
            }
            
            return items.length > 0 ? items : null;
        }
        
        // Fallbackï¼šå¾å…¨æ–‡æœ¬æå–è¡¨æ ¼é …ç›®
        function extractTableItemsFromText(fullText) {
            const items = [];
            const lines = fullText.split('\n');
            let inTable = false;
            let currentItem = {};
            
            lines.forEach((line, idx) => {
                const content = line.trim();
                const upperContent = content.toUpperCase();
                
                // æª¢æ¸¬è¡¨æ ¼é–‹å§‹
                if (upperContent.includes('QUANTITY') || upperContent.includes('ITEM NO')) {
                    inTable = true;
                    return;
                }
                
                // æª¢æ¸¬è¡¨æ ¼çµæŸ
                if (inTable && (upperContent.includes('TOTAL') || upperContent.includes('FOR AND'))) {
                    if (Object.keys(currentItem).length > 0) {
                        items.push(currentItem);
                    }
                    inTable = false;
                    return;
                }
                
                if (inTable && content.length > 0) {
                    // ç°¡å–®çš„è¡Œé …ç›®æå–
                    const parts = content.split(/\s{2,}|\t/);
                    
                    if (parts[0] && /^\d+$/.test(parts[0])) {
                        if (Object.keys(currentItem).length > 0) {
                            items.push(currentItem);
                        }
                        currentItem = {
                            lineNo: parts[0],
                            quantity: null,
                            unit: null,
                            itemNo: parts[1] || null,
                            description: parts[2] || null,
                            unitPrice: null,
                            amount: null,
                            poNo: null
                        };
                        
                        // å˜—è©¦æå–æ•¸å€¼æ¬„ä½
                        parts.slice(3).forEach(part => {
                            const num = parseFloat(part.replace(/[^\d.]/g, ''));
                            if (!isNaN(num)) {
                                if (num < 1000 && !currentItem.unitPrice) {
                                    currentItem.unitPrice = num;
                                } else if (num >= 1000 && !currentItem.amount) {
                                    currentItem.amount = num;
                                } else if (num > 100000 && !currentItem.poNo) {
                                    currentItem.poNo = part;
                                }
                            }
                        });
                    }
                }
            });
            
            if (Object.keys(currentItem).length > 0) {
                items.push(currentItem);
            }
            
            return items.length > 0 ? items : null;
        }
        
        // å¾è¨‚å–®æå–é—œéµæ¬„ä½ï¼ˆç²¾ç°¡ç‰ˆï¼‰
        function extractOrderFields(fullText, pages) {
            const fields = {};
            
            // Order Number / PO Number
            let orderMatch = fullText.match(/(?:ORDER|PO)\s*(?:NO|#)?[\s:]*([^\n]+)/i);
            fields.orderNo = orderMatch ? orderMatch[1].trim() : null;
            
            // Date
            let dateMatch = fullText.match(/(?:DATE|ORDER DATE)[\s:]*(\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/i);
            fields.date = dateMatch ? dateMatch[1] : null;
            
            // Quantity
            let qtyMatch = fullText.match(/(?:QTY|QUANTITY)[\s:]*(\d+)/i);
            fields.quantity = qtyMatch ? parseInt(qtyMatch[1]) : null;
            
            return fields;
        }

        
        // è§£æç™¼ç¥¨è³‡æ–™
        function parseInvoiceData(textLines, lines) {
            const data = {};
            
            // å˜—è©¦æ‰¾å‡ºé—œéµæ¬„ä½
            textLines.forEach((line, index) => {
                const upperLine = line.toUpperCase();
                
                // Invoice Number - å¤šç¨®æ ¼å¼æ”¯æ´
                if (upperLine.includes('INVOICE NO') || upperLine.includes('INV NO') || upperLine.includes('INVOICE#')) {
                    // æ”¯æ´å¤šç¨®æ ¼å¼ï¼šAB-12345678, AB12345678, 20200662511106A ç­‰
                    let match = line.match(/[A-Z]{2,4}[\-\s]?\d{8,}/i) || 
                                textLines[index + 1]?.match(/[A-Z]{2,4}[\-\s]?\d{8,}/i);
                    
                    // å¦‚æœä¸Šé¢æ²’æ‰¾åˆ°ï¼Œå˜—è©¦æ‰¾ç´”æ•¸å­—å¾Œè·Ÿå­—æ¯çš„æ ¼å¼
                    if (!match) {
                        match = line.match(/\d{8,}[A-Z]{1,3}/) ||
                                textLines[index + 1]?.match(/\d{8,}[A-Z]{1,3}/);
                    }
                    
                    // å¦‚æœé‚„æ˜¯æ²’æ‰¾åˆ°ï¼Œç›´æ¥å– INVOICE NO å¾Œé¢çš„éç©ºç™½å…§å®¹
                    if (!match) {
                        const invoiceMatch = line.match(/INVOICE\s*NO[\s:]*([^\s\n]+)/i) ||
                                           textLines[index + 1]?.match(/([^\s\n]+)/);
                        if (invoiceMatch) match = invoiceMatch;
                    }
                    
                    if (match) {
                        // å¦‚æœ match æ˜¯é™£åˆ—ï¼Œå–ç¬¬ 0 å€‹æˆ–æœ€å¾Œä¸€å€‹å…ƒç´ 
                        const invoiceNo = Array.isArray(match) ? (match[1] || match[0]) : match[0];
                        data['ç™¼ç¥¨è™Ÿç¢¼'] = invoiceNo.trim();
                    }
                }
                
                // Date
                if (upperLine.includes('DATE') && !upperLine.includes('UPDATE')) {
                    const match = line.match(/\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/) ||
                                  textLines[index + 1]?.match(/\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/);
                    if (match) data['ç™¼ç¥¨æ—¥æœŸ'] = match[0];
                }
                
                // Customer Name / Seller
                if (upperLine.includes('CUSTOMER') || upperLine.includes('SOLD TO') || upperLine.includes('BUYER')) {
                    const nextLine = textLines[index + 1];
                    if (nextLine && nextLine.trim().length > 3) {
                        data['å®¢æˆ¶åç¨±'] = nextLine.trim();
                    }
                }
                
                // Total Amount - æ”¯æ´ TOTAL åœ¨ä¸åŒè¡Œçš„æƒ…æ³
                if (upperLine.includes('TOTAL') && !upperLine.includes('DESCRIPTION')) {
                    // å…ˆå˜—è©¦å¾åŒä¸€è¡Œå°‹æ‰¾
                    let match = line.match(/[\d,]+\.?\d+/);
                    
                    // å¦‚æœåŒè¡Œæ²’æœ‰æ•¸å­—ï¼Œå¾ä¸‹ä¸€è¡Œå°‹æ‰¾
                    if (!match && index + 1 < textLines.length) {
                        match = textLines[index + 1].match(/^[\d,]+\.?\d+/);
                    }
                    
                    if (match) {
                        data['ç¸½è¨ˆ'] = match[0];
                    }
                }
                
                // Currency - æ”¯æ´å¾ Amount(USD) ç­‰æ ¼å¼ä¸­æå–
                if (!data['å¹£åˆ¥']) {
                    // å…ˆå˜—è©¦å¾ Amount(USD), Price(USD) ç­‰æ ¼å¼æå–
                    let currencyMatch = line.match(/Amount\s*\(\s*([A-Z]{3})\s*\)/i) ||
                                       line.match(/Price\s*\(\s*([A-Z]{3})\s*\)/i) ||
                                       line.match(/Currency\s*[:\s]*([A-Z]{3})/i);
                    
                    if (currencyMatch) {
                        data['å¹£åˆ¥'] = currencyMatch[1].toUpperCase();
                    } else if (upperLine.includes('USD') || upperLine.includes('NT') || upperLine.includes('TWD')) {
                        data['å¹£åˆ¥'] = upperLine.includes('USD') ? 'USD' : 'TWD';
                    }
                }
            });
            
            // è¨­å®šé è¨­å€¼
            data['ç™¼ç¥¨è™Ÿç¢¼'] = data['ç™¼ç¥¨è™Ÿç¢¼'] || 'æœªè­˜åˆ¥';
            data['ç™¼ç¥¨æ—¥æœŸ'] = data['ç™¼ç¥¨æ—¥æœŸ'] || 'æœªè­˜åˆ¥';
            data['å®¢æˆ¶åç¨±'] = data['å®¢æˆ¶åç¨±'] || 'æœªè­˜åˆ¥';
            data['ç¸½è¨ˆ'] = data['ç¸½è¨ˆ'] || '0.00';
            data['å¹£åˆ¥'] = data['å¹£åˆ¥'] || 'TWD';
            data['ç‹€æ…‹'] = 'âœ… å·²è¾¨è­˜';
            data['è¾¨è­˜ä¿¡è³´åº¦'] = '95%';
            
            return data;
        }
        
        // è§£æè¨‚å–®è³‡æ–™
        function parseOrderData(textLines, lines) {
            const data = {};
            
            textLines.forEach((line, index) => {
                const upperLine = line.toUpperCase();
                
                if (upperLine.includes('ORDER') || upperLine.includes('PO')) {
                    const match = line.match(/[A-Z]{2}\d{6,}/i);
                    if (match) data['è¨‚å–®ç·¨è™Ÿ'] = match[0];
                }
                
                if (upperLine.includes('DATE')) {
                    const match = line.match(/\d{4}[-\/]\d{1,2}[-\/]\d{1,2}/);
                    if (match) data['è¨‚å–®æ—¥æœŸ'] = match[0];
                }
                
                if (upperLine.includes('QTY') || upperLine.includes('QUANTITY')) {
                    const match = line.match(/\d+/);
                    if (match) data['æ•¸é‡'] = match[0];
                }
            });
            
            data['è¨‚å–®ç·¨è™Ÿ'] = data['è¨‚å–®ç·¨è™Ÿ'] || 'æœªè­˜åˆ¥';
            data['è¨‚å–®æ—¥æœŸ'] = data['è¨‚å–®æ—¥æœŸ'] || 'æœªè­˜åˆ¥';
            data['æ•¸é‡'] = data['æ•¸é‡'] || '0';
            data['ç‹€æ…‹'] = 'âœ… å·²è¾¨è­˜';
            
            return data;
        }

        function showOCRResults() {
            updateStep(2);
            showLayer('layer2');
            
            // æ›´æ–°ä¿¡è³´åº¦é¡¯ç¤º
            updateConfidenceDisplay();
            
            // é¡¯ç¤ºå®Œæ•´ JSON çµæœ
            if (ocrData._raw) {
                const jsonContent = document.getElementById('jsonContent');
                
                // ç›´æ¥é¡¯ç¤ºå®Œæ•´ JSONï¼ˆåŸå§‹ç‰ˆæœ¬ï¼‰
                jsonContent.textContent = JSON.stringify(ocrData._raw, null, 2);
            }
            
            // é¡¯ç¤ºå®Œæ•´æ–‡å­—å…§å®¹ (å¯é¸)
            if (ocrData._allText) {
                const textContent = ocrData._allText.substring(0, 500) + (ocrData._allText.length > 500 ? '...' : '');
                console.log('å®Œæ•´ OCR æ–‡å­—:\n', textContent);
            }
            
            // æ–°å¢ï¼šåœ¨ç€è¦½å™¨ console è¼¸å‡ºç²¾ç°¡è³‡æ–™ä¾›è¤‡è£½ä½¿ç”¨
            console.log('ã€æ–¹æ¡ˆ A æ”¹é€²ç‰ˆ - è©³ç´°æå–è³‡æ–™ã€‘', ocrData._simplified);
            console.log('ã€åŸå§‹ Document Intelligence å›æ‡‰ã€‘', ocrData._raw);
            
            // âŒ å·²å–æ¶ˆè‡ªå‹•è·³è½‰ - ç­‰å¾…ä½¿ç”¨è€…æ‰‹å‹•ç¢ºèª
            console.log('âœ… OCR å®Œæˆï¼Œè«‹ç¢ºèªçµæœå¾Œæ‰‹å‹•é»æ“Šã€Œç¢ºèªä¸¦ç¹¼çºŒã€');
            // confirmOCR();
        }
        
        // æ›´æ–°ä¿¡è³´åº¦é¡¯ç¤º
        function updateConfidenceDisplay() {
            const confidenceBadge = document.getElementById('confidenceBadge');
            if (!confidenceBadge) return;
            
            let confidenceValue = null;
            let confidenceColor = '#4caf50'; // é è¨­ç¶ è‰²
            
            // å¾ ocrData ä¸­ç²å–ä¿¡è³´åº¦
            if (ocrData?._confidence?.overall) {
                confidenceValue = ocrData._confidence.overall;
            } else if (ocrData?._meta?.confidence?.overall) {
                confidenceValue = ocrData._meta.confidence.overall;
            } else if (ocrData?._confidence?.document) {
                confidenceValue = ocrData._confidence.document;
            } else if (ocrData?._confidence?.averageFieldConfidence) {
                confidenceValue = ocrData._confidence.averageFieldConfidence;
            }
            
            // æ ¹æ“šä¿¡è³´åº¦è¨­å®šé¡è‰²
            if (confidenceValue !== null) {
                if (confidenceValue >= 90) {
                    confidenceColor = '#4caf50'; // ç¶ è‰² (é«˜ä¿¡è³´åº¦)
                } else if (confidenceValue >= 70) {
                    confidenceColor = '#ff9800'; // æ©˜è‰² (ä¸­ç­‰ä¿¡è³´åº¦)
                } else {
                    confidenceColor = '#f44336'; // ç´…è‰² (ä½ä¿¡è³´åº¦)
                }
                
                confidenceBadge.textContent = `ä¿¡è³´åº¦: ${confidenceValue.toFixed(1)}%`;
                confidenceBadge.style.background = confidenceColor;
                confidenceBadge.style.color = 'white';
                
                console.log(`ğŸ“Š é¡¯ç¤ºä¿¡è³´åº¦: ${confidenceValue.toFixed(1)}%`);
            } else {
                // å¦‚æœæ²’æœ‰ä¿¡è³´åº¦è³‡è¨Šï¼Œé¡¯ç¤º N/A
                confidenceBadge.textContent = 'ä¿¡è³´åº¦: N/A';
                confidenceBadge.style.background = 'rgba(255, 255, 255, 0.2)';
                console.log('âš ï¸ æœªç²å–åˆ°ä¿¡è³´åº¦è³‡è¨Š');
            }
        }
        
        // è·³è½‰åˆ°ç™¼ç¥¨æ ¼å¼è½‰æ›é é¢
        function redirectToFormatConverter() {
            // æ¸…é™¤è‡ªå‹•è·³è½‰è¨ˆæ™‚å™¨
            if (window.autoRedirectInterval) {
                clearInterval(window.autoRedirectInterval);
            }
            
            if (ocrData) {
                // æº–å‚™è¦å‚³éçš„è³‡æ–™
                const jsonToSave = {
                    meta: ocrData._raw?.analyzeResult?.apiVersion ? {
                        apiVersion: ocrData._raw.analyzeResult.apiVersion,
                        model: ocrData._raw.analyzeResult.modelId,
                        pageCount: (ocrData._raw.analyzeResult.pages || []).length,
                        timestamp: new Date().toISOString()
                    } : {
                        timestamp: new Date().toISOString()
                    },
                    extracted: ocrData._simplified?.extracted || {},
                    fullText: ocrData._simplified?.fullText || ocrData._allText || '',
                    // ä¿ç•™åŸå§‹è³‡æ–™ä¾›é€²éšè™•ç†
                    pages: ocrData._raw?.analyzeResult?.pages || ocrData._raw?.pages || [],
                    tables: ocrData._raw?.analyzeResult?.tables || ocrData._raw?.tables || []
                };
                
                console.log('ğŸ’¾ ä¿å­˜ OCR çµæœåˆ° localStorage:', jsonToSave);
                localStorage.setItem('ocrResult', JSON.stringify(jsonToSave));
                
                console.log('ğŸ”— è·³è½‰åˆ°ç™¼ç¥¨æ ¼å¼è½‰æ›é é¢...');
                window.location.href = 'invoice_format_converter.html';
            } else {
                alert('æ²’æœ‰å¯ç”¨çš„ OCR è³‡æ–™ï¼');
            }
        }

        // è¤‡è£½ JSON åˆ°å‰ªè²¼ç°¿
        function copyJSONToClipboard() {
            const jsonContent = document.getElementById('jsonContent');
            const text = jsonContent.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyJsonBtn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—: ' + err);
            });
        }

        function retryOCR() {
            // å–æ¶ˆè‡ªå‹•è·³è½‰
            if (window.autoRedirectInterval) {
                clearInterval(window.autoRedirectInterval);
            }
            
            if (confirm('ç¢ºå®šè¦é‡æ–°è¾¨è­˜å—ï¼Ÿé€™å°‡é‡æ–°è™•ç†ä¸Šå‚³çš„æ–‡ä»¶ã€‚')) {
                startOCR();
            }
        }

        function confirmOCR() {
            console.log('ğŸ”´ confirmOCR() è¢«å‘¼å«');
            console.log('ğŸ”´ ocrData ç‹€æ…‹:', ocrData);
            
            // å–æ¶ˆè‡ªå‹•è·³è½‰
            if (window.autoRedirectInterval) {
                clearInterval(window.autoRedirectInterval);
            }
            
            // âœ… å³ä½¿æ²’æœ‰ ocrData ä¹Ÿè¦è·³è½‰
            try {
                let jsonToSave = {};
                
                if (ocrData) {
                    // å–å¾—ä¿¡è³´åº¦è³‡è¨Š
                    const confidence = ocrData._confidence || ocrData._meta?.confidence || {};
                    const confidenceInfo = {
                        document: confidence.document || null,
                        averagePageConfidence: confidence.averagePageConfidence || null,
                        averageFieldConfidence: confidence.averageFieldConfidence || null,
                        overall: confidence.overall || confidence.averagePageConfidence || confidence.document || null
                    };
                    console.log('ğŸ“Š æº–å‚™å‚³éçš„ä¿¡è³´åº¦:', confidenceInfo);
                    
                    // æƒ…æ³ 1ï¼šæ–°æ ¼å¼ï¼ˆå·²åœ¨ Azure Function ä¸­çµæ§‹åŒ–ï¼Œæœ‰ _meta å±¬æ€§ï¼‰
                    if (ocrData._meta) {
                        jsonToSave = {
                            invoiceNo: ocrData.invoiceNo || 'æœªçŸ¥ç™¼ç¥¨è™Ÿ',
                            date: ocrData.date || new Date().toISOString().split('T')[0],
                            seller: ocrData.seller || 'æœªçŸ¥è³£æ–¹',
                            buyer: ocrData.buyer || '',
                            purchaseOrder: ocrData.purchaseOrder || ocrData.customerPO || '',
                            totalAmount: ocrData.totalAmount || 0,
                            currency: ocrData.currency || 'USD',
                            items: Array.isArray(ocrData.items) ? ocrData.items : [],
                            sellerAddress: ocrData.sellerAddress || '',
                            buyerAddress: ocrData.buyerAddress || '',
                            tradeTerm: ocrData.tradeTerm || '',
                            origin: ocrData.origin || '',
                            contact: ocrData.contact || '',
                            confidence: confidenceInfo
                        };
                    }
                    // æƒ…æ³ 2ï¼šèˆŠæ ¼å¼ï¼ˆä½¿ç”¨ _simplifiedï¼‰
                    else if (ocrData._simplified) {
                        const extracted = ocrData._simplified.extracted || {};
                        jsonToSave = {
                            invoiceNo: extracted.invoiceNo || ocrData.invoiceNo || 'æœªçŸ¥ç™¼ç¥¨è™Ÿ',
                            date: extracted.date || ocrData.date || new Date().toISOString().split('T')[0],
                            seller: extracted.seller || ocrData.seller || 'æœªçŸ¥è³£æ–¹',
                            buyer: extracted.buyer || ocrData.buyer || '',
                            purchaseOrder: extracted.purchaseOrder || '',
                            totalAmount: extracted.totalAmount || ocrData.totalAmount || 0,
                            currency: extracted.currency || ocrData.currency || 'USD',
                            items: extracted.items || ocrData.items || [],
                            confidence: confidenceInfo
                        };
                    }
                    // æƒ…æ³ 3ï¼šç›´æ¥ä½¿ç”¨ ocrData çš„å±¬æ€§
                    else {
                        jsonToSave = {
                            invoiceNo: ocrData.invoiceNo || ocrData['ç™¼ç¥¨è™Ÿç¢¼'] || 'æœªçŸ¥ç™¼ç¥¨è™Ÿ',
                            date: ocrData.date || ocrData['ç™¼ç¥¨æ—¥æœŸ'] || new Date().toISOString().split('T')[0],
                            seller: ocrData.seller || ocrData['å®¢æˆ¶åç¨±'] || 'æœªçŸ¥è³£æ–¹',
                            buyer: ocrData.buyer || '',
                            totalAmount: ocrData.totalAmount || parseFloat(ocrData['ç¸½è¨ˆ']) || 0,
                            currency: ocrData.currency || ocrData['å¹£åˆ¥'] || 'USD',
                            items: Array.isArray(ocrData.items) ? ocrData.items : [],
                            confidence: confidenceInfo
                        };
                    }
                } else {
                    console.warn('âš ï¸ ocrData ç‚ºç©ºï¼Œä½¿ç”¨é è¨­å€¼');
                    jsonToSave = {
                        invoiceNo: 'æœªçŸ¥ç™¼ç¥¨è™Ÿ',
                        date: new Date().toISOString().split('T')[0],
                        seller: 'æœªçŸ¥è³£æ–¹',
                        buyer: '',
                        totalAmount: 0,
                        currency: 'USD',
                        items: []
                    };
                }
                
                console.log('ğŸ’¾ ä¿å­˜ OCR çµæœåˆ° localStorage:', jsonToSave);
                localStorage.setItem('ocrResult', JSON.stringify(jsonToSave));
                
                // âœ… æ ¹æ“šæ–‡ä»¶é¡å‹è·³è½‰åˆ°ç›¸æ‡‰çš„æ ¼å¼è½‰æ›é é¢
                let targetPage = 'invoice_format_converter.html';
                if (selectedType === 'order') {
                    targetPage = 'po_format_converter.html';
                    console.log('ğŸ”— æ­£åœ¨è·³è½‰åˆ°æ¡è³¼å–®æ ¼å¼è½‰æ›é é¢...');
                } else {
                    console.log('ğŸ”— æ­£åœ¨è·³è½‰åˆ°ç™¼ç¥¨æ ¼å¼è½‰æ›é é¢...');
                }
                window.location.href = targetPage;
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ OCR çµæœæ™‚å‡ºéŒ¯:', error);
                alert('âŒ éŒ¯èª¤: ' + error.message + '\n\nä»å°‡å˜—è©¦è·³è½‰...');
                // å³ä½¿å‡ºéŒ¯ä¹Ÿå˜—è©¦è·³è½‰
                let targetPage = selectedType === 'order' ? 'po_format_converter.html' : 'invoice_format_converter.html';
                window.location.href = targetPage;
            }
        }

        // ===== å°èˆªåŠŸèƒ½ =====

        function resetToStart() {
            // å–æ¶ˆè‡ªå‹•è·³è½‰
            if (window.autoRedirectInterval) {
                clearInterval(window.autoRedirectInterval);
            }
            
            selectedType = null;
            uploadedFile = null;
            selectedFormat = null;
            ocrData = null;
            
            document.getElementById('invoiceCard').classList.remove('selected');
            document.getElementById('orderCard').classList.remove('selected');
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfoArea').classList.add('hidden');
            
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.add('disabled');
            uploadZone.onclick = null;
            uploadZone.querySelector('h3').textContent = 'è«‹å…ˆé¸æ“‡æ–‡ä»¶é¡å‹';
            uploadZone.querySelector('p').textContent = 'é¸æ“‡ä¸Šæ–¹çš„ç™¼ç¥¨æˆ–è¨‚å–®å¾Œå³å¯ä¸Šå‚³';
            
            updateStep(1);
            showLayer('layer1');
        }

        // ===== è¼”åŠ©åŠŸèƒ½ =====
        function updateStep(step) {
            for (let i = 1; i <= 2; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (i === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            }
        }

        function showLayer(layerId) {
            ['layer1', 'layer2'].forEach(id => {
                const layer = document.getElementById(id);
                if (id === layerId) {
                    layer.classList.remove('hidden');
                } else {
                    layer.classList.add('hidden');
                }
            });
        }

        function showProcessing(text, detail) {
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingDetail').textContent = detail;
            document.getElementById('processingOverlay').classList.remove('hidden');
        }

        function updateProcessing(text, detail) {
            document.getElementById('processingText').textContent = text;
            document.getElementById('processingDetail').textContent = detail;
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.add('hidden');
        }
    </script>
</body>
</html>
