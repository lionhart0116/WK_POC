<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡åŒ¯å‡ºæ ¼å¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ================= å…¨åŸŸæ¨£å¼ ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .page-header { text-align: center; color: white; margin-bottom: 40px; }
        .page-header h1 { font-size: 36px; margin-bottom: 10px; }
        
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .steps-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 40px; gap: 20px; }
        .step { display: flex; align-items: center; gap: 10px; }
        .step-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }
        .step.completed .step-circle { background: #4caf50; color: white; }
        .step.active .step-circle { background: white; color: #667eea; transform: scale(1.1); }
        .step-label { color: white; font-size: 14px; opacity: 0.7; }
        .step.active .step-label { opacity: 1; font-weight: 600; }
        .step-arrow { color: white; opacity: 0.5; font-size: 20px; }

        /* å¡ç‰‡æ¨£å¼ */
        .main-card {
            background: white; border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px;
            min-height: 500px; animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* æ‘˜è¦å€å¡Š */
        .data-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3; padding: 25px; border-radius: 12px; margin-bottom: 40px;
        }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .summary-item { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .summary-label { font-size: 12px; color: #666; margin-bottom: 5px; text-transform: uppercase; font-weight: 600; }
        .summary-value { font-size: 16px; font-weight: 600; color: #333; }
        .summary-value.highlight { color: #2196f3; font-size: 18px; }

        /* æ ¼å¼é¸æ“‡å€ */
        .format-selection-area { margin-bottom: 40px; }
        .format-group-title { font-size: 16px; color: #666; margin-bottom: 15px; border-left: 3px solid #667eea; padding-left: 10px; }
        
        .format-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
        
        .format-card {
            background: white; border: 2px solid #e0e0e0;
            border-radius: 12px; padding: 20px; cursor: pointer;
            transition: all 0.2s ease; text-align: center; position: relative;
        }
        .format-card:hover { border-color: #667eea; transform: translateY(-3px); }
        .format-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea; color: white;
        }
        .format-icon { font-size: 32px; margin-bottom: 10px; }
        .format-name { font-weight: bold; margin-bottom: 5px; }
        .format-desc { font-size: 12px; opacity: 0.8; }
        .check-mark { position: absolute; top: 10px; right: 10px; display: none; }
        .format-card.selected .check-mark { display: block; }

        /* æŒ‰éˆ• */
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn { padding: 14px 32px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; background: #ccc; }

        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>ğŸ¤– æ™ºæ…§æ–‡ä»¶è™•ç†ç³»çµ±</h1>
            <p>Powered by Copilot Studio & Azure OpenAI</p>
        </div>

        <div class="steps-indicator">
            <div class="step completed">
                <div class="step-circle">âœ“</div>
                <div class="step-label">é¸æ“‡é¡å‹</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step completed">
                <div class="step-circle">âœ“</div>
                <div class="step-label">ç¢ºèª OCR</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step active">
                <div class="step-circle">3</div>
                <div class="step-label">åŒ¯å‡ºæ ¼å¼</div>
            </div>
        </div>

        <div class="main-card">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“‹ è³‡æ–™æ‘˜è¦èˆ‡åŒ¯å‡º</h2>

            <div class="data-summary">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; color:#1976d2;">
                    <span style="font-size:24px;">ğŸ“Š</span>
                    <h4 style="font-size:18px;">è³‡æ–™ç¢ºèª</h4>
                </div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">æ–‡ä»¶ç·¨è™Ÿ</div>
                        <div class="summary-value" id="sum_invoice_no">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">æ–‡ä»¶æ—¥æœŸ</div>
                        <div class="summary-value" id="sum_invoice_date">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">è³£æ–¹/ä¾›æ‡‰å•†</div>
                        <div class="summary-value" id="sum_seller_id">--</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ç¸½é‡‘é¡</div>
                        <div class="summary-value highlight" id="sum_grand_total">--</div>
                    </div>
                </div>
            </div>

            <div class="format-selection-area">
                <h3 class="format-group-title" id="formatTitle">è«‹é¸æ“‡ç›®æ¨™ç³»çµ±æ ¼å¼ï¼š</h3>
                <div class="format-options" id="formatContainer">
                    </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goBackToEdit()">â† è¿”å›ä¿®æ”¹</button>
                <button class="btn btn-primary" id="downloadBtn" onclick="generateAndDownload()" disabled>â¬‡ï¸ ç”¢ç”Ÿä¸¦ä¸‹è¼‰æª”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // === å…¨å±€è®Šæ•¸ ===
        let currentData = {};
        let selectedFormat = null;
        let docType = 'invoice'; // é è¨­å€¼

        // === æ ¼å¼è¨­å®šå®šç¾© ===
        // åŒ…å«æ‰€æœ‰æ ¼å¼çš„è©³ç´°è¨­å®š (Header, æª”åè¦å‰‡, Mapping)
        const allFormats = {
            '406': {
                id: '406', name: '406INF æ ¼å¼', desc: '406INF.xlsx (Excel)', icon: 'ğŸ“Š', ext: 'xlsx',
                headers: [
                    "Batch_Name", "Vendor Num", "Vendor Site Code", "Type", "PO No", 
                    "PO Line Num", "Release", "Shipment Num", "Vendor Item", "Item No", 
                    "Qty", "Ship-To", "Subinventory", "Release Price", "INV NO", 
                    "Invoice_Date[ ]", "COO[ ]", "Book_Cost[ ]", "Real_Cost[ ]", "Lot_no[ ]", 
                    "Declarations_price[ ]", "ä¿å›ºæœŸ [ ]", "check_sum[ ]", "ç‡’éŒ„å°è±¡ [ ]", 
                    "Ship_to_code[ ]", "SO[ ]", "DO[ ]", "Reason[ ]", "èˆŠæ”¶æ–™å–®è™Ÿ [ ]", 
                    "MAWB[ ]", "HAWB[ ]", "åˆ°è²¨é€šçŸ¥[ ]", "Specialç®¡åˆ¶æ–™", "å¿…ç´°é©—"
                ],
                // è³‡æ–™å°æ‡‰é‚è¼¯
                mapFn: (data) => ({
                    "Batch_Name": "OCR_BATCH_" + new Date().toISOString().slice(0,10).replace(/-/g,''), // è‡ªå‹•ç”¢ç”Ÿæ‰¹è™Ÿ
                    "Vendor Num": data.seller_id || "",     // å°æ‡‰ï¼šè³£æ–¹çµ±ç·¨
                    "Vendor Site Code": "TW_SITE",          // ç¯„ä¾‹ï¼šä¾›æ‡‰å•†åœ°é» (éœ€è¦–ç³»çµ±è¨­å®š)
                    "Type": "STANDARD",                     // ç¯„ä¾‹ï¼šæ¨™æº–é¡å‹
                    "PO No": "",                            // OCR æœªåŒ…å« POï¼Œç•™ç©ºå¾…å¡«
                    "PO Line Num": "1",                     // é è¨­ç¬¬ä¸€è¡Œ
                    "Release": "",
                    "Shipment Num": data.invoice_no,        // å¸¸è¦‹åšæ³•ï¼šç”¨ç™¼ç¥¨è™Ÿç•¶å‡ºè²¨å–®è™Ÿ
                    "Vendor Item": "",
                    "Item No": data.item_name || "MISC",    // å°æ‡‰ï¼šå“å
                    "Qty": data.quantity || "1",            // å°æ‡‰ï¼šæ•¸é‡
                    "Ship-To": data.buyer_name || "",       // å°æ‡‰ï¼šè²·æ–¹åç¨±
                    "Subinventory": "Stores",               // ç¯„ä¾‹ï¼šå­åº«å­˜
                    "Release Price": data.grand_total || "",// å°æ‡‰ï¼šé‡‘é¡ (æˆ–ç”¨å–®åƒ¹)
                    "INV NO": data.invoice_no,              // å°æ‡‰ï¼šç™¼ç¥¨è™Ÿç¢¼
                    "Invoice_Date[ ]": data.invoice_date,   // å°æ‡‰ï¼šç™¼ç¥¨æ—¥æœŸ
                    "COO[ ]": "",
                    "Book_Cost[ ]": "",
                    "Real_Cost[ ]": "",
                    "Lot_no[ ]": "",
                    "Declarations_price[ ]": "",
                    "ä¿å›ºæœŸ [ ]": "",
                    "check_sum[ ]": "",
                    "ç‡’éŒ„å°è±¡ [ ]": "",
                    "Ship_to_code[ ]": "",
                    "SO[ ]": "",
                    "DO[ ]": "",
                    "Reason[ ]": "",
                    "èˆŠæ”¶æ–™å–®è™Ÿ [ ]": "",
                    "MAWB[ ]": "",
                    "HAWB[ ]": "",
                    "åˆ°è²¨é€šçŸ¥[ ]": "",
                    "Specialç®¡åˆ¶æ–™": "N",
                    "å¿…ç´°é©—": "N"
                })
            },
            '407': {
                id: '407', name: '407INF æ ¼å¼', desc: '407INF.csv (CSV)', icon: 'ğŸ“‹', ext: 'csv',
                headers: [
                    "Vendor_doc_num", "PO_NUM", "PO_LINE_NUM", "Item", 
                    "Agent Name", "Quantity", "Price", "Promised Date", 
                    "Destin_Num", "Ship_to", "Deliver_to", "Subinventory"
                ],
                // è³‡æ–™å°æ‡‰é‚è¼¯
                mapFn: (data) => ({
                    "Vendor_doc_num": data.invoice_no || "",    // å°æ‡‰ï¼šç™¼ç¥¨è™Ÿç¢¼
                    "PO_NUM": "",                               // OCR æœªæä¾›ï¼Œç•™ç©º
                    "PO_LINE_NUM": "1",                         // é è¨­ç¬¬ä¸€è¡Œ
                    "Item": data.item_name || "",               // å°æ‡‰ï¼šå“å
                    "Agent Name": data.seller_name || "",       // å°æ‡‰ï¼šè³£æ–¹/ä¾›æ‡‰å•†åç¨±
                    "Quantity": data.quantity || "1",           // å°æ‡‰ï¼šæ•¸é‡
                    "Price": data.unit_price || data.grand_total || "", // å°æ‡‰ï¼šå–®åƒ¹æˆ–ç¸½åƒ¹
                    "Promised Date": "",
                    "Destin_Num": "",
                    "Ship_to": data.buyer_address || "",        // å°æ‡‰ï¼šè²·æ–¹åœ°å€ (Ship_to)
                    "Deliver_to": "",
                    "Subinventory": "STORES"                    // ç¯„ä¾‹å€¼
                })
            },
            'CO': {
                id: 'CO', name: 'CO æ¡è³¼å–®', desc: 'CO.csv (æ¡è³¼ç³»çµ±)', icon: 'ğŸ“¦', ext: 'csv',
                headers: [
                    "Co_Number", "Cust_Po_Number", "Cust_Po_Line_num", "å®¢æˆ¶æ–™è™Ÿ", 
                    "åŸå» æ–™è™Ÿ", "Co_Qty", "ä¸Šå‚³è€…", "Unit_Selling_Price", 
                    "Cust_Request_Date", "DPA_NO", "Cust_Order_Date", "N_Ver", 
                    "N_åŸå§‹æ•¸é‡", "End_Customer", "N_CSD_Date"
                ],
                // è³‡æ–™å°æ‡‰é‚è¼¯
                mapFn: (data) => ({
                    // === åŸºæœ¬å°æ‡‰ ===
                    "Co_Number": "CO-" + (data.invoice_no || 'TBD'), // æ¡ç”¨ç™¼ç¥¨è™Ÿç¢¼ä½œç‚º CO è™Ÿç¢¼çš„ä¸€éƒ¨åˆ†
                    "Cust_Po_Number": data.invoice_no || "",          // æš«ä»¥ç™¼ç¥¨è™Ÿç¢¼è¦–ç‚º PO è™Ÿç¢¼
                    "Cust_Po_Line_num": "1",
                    
                    // === å“é …å°æ‡‰ ===
                    "å®¢æˆ¶æ–™è™Ÿ": data.item_name || "",            // æ¡ç”¨å“åä½œç‚ºå®¢æˆ¶æ–™è™Ÿ
                    "åŸå» æ–™è™Ÿ": "",                              // OCR æœªæä¾›ï¼Œç•™ç©º
                    "Co_Qty": data.quantity || "1",             // å°æ‡‰ï¼šæ•¸é‡
                    "Unit_Selling_Price": data.unit_price || "",// å°æ‡‰ï¼šå–®åƒ¹
                    
                    // === è³‡è¨Šèˆ‡æ—¥æœŸå°æ‡‰ ===
                    "ä¸Šå‚³è€…": "OCR_USER",
                    "Cust_Request_Date": data.invoice_date || "",// æ¡ç”¨ç™¼ç¥¨æ—¥æœŸä½œç‚ºå®¢æˆ¶è¦æ±‚æ—¥
                    "DPA_NO": "",
                    "Cust_Order_Date": data.invoice_date || "",  // æ¡ç”¨ç™¼ç¥¨æ—¥æœŸä½œç‚ºè¨‚å–®æ—¥
                    "N_Ver": "A",                                // é è¨­ç‰ˆæœ¬
                    "N_åŸå§‹æ•¸é‡": data.quantity || "1",             // èˆ‡ Co_Qty ç›¸åŒ
                    "End_Customer": data.buyer_name || "",       // æ¡ç”¨è²·æ–¹åç¨±ä½œç‚ºçµ‚ç«¯å®¢æˆ¶
                    "N_CSD_Date": ""
                })
            },
            'SO': {
                id: 'SO', name: 'SO è¨‚å–®', desc: 'SO.csv (æ¥­å‹™ç³»çµ±)', icon: 'ğŸ›’', ext: 'csv',
                headers: [
                    "UPLOAD NO", "LINE", "CUSTOMER NO.", "PO NO.", "ORDER TYPE", 
                    "DATE", "SHIP TO", "SHIP TO ATTN", "BILL TO", "CURRENCYY", 
                    "PRICE BOOK", "SALES", "PAYMENT TERM", "WH", "LINE SET", 
                    "SHIPPING METHOD", "FOB", "SHIPPING INSTRUCTIONS", "CONVERSION TYPE"
                ],
                // è³‡æ–™å°æ‡‰é‚è¼¯
                mapFn: (data) => ({
                    // === æ ¸å¿ƒèˆ‡è­˜åˆ¥è³‡è¨Š ===
                    "UPLOAD NO": "OCR_SO_UPLOAD_" + Date.now().toString().slice(-6), // æ‰¹æ¬¡ä¸Šå‚³ç·¨è™Ÿ
                    "LINE": "1",                                     // é è¨­ç¬¬ä¸€è¡Œ
                    "CUSTOMER NO.": data.buyer_id || "",             // å°æ‡‰ï¼šè²·æ–¹çµ±ç·¨ (è¦–ç‚ºå®¢æˆ¶ç·¨è™Ÿ)
                    "PO NO.": data.invoice_no || "",                 // æš«ç”¨ç™¼ç¥¨è™Ÿç¢¼ä½œç‚º PO åƒè€ƒ
                    "ORDER TYPE": "STANDARD",                        // ç¯„ä¾‹ï¼šæ¨™æº–è¨‚å–®
                    "DATE": data.invoice_date || "",                 // å°æ‡‰ï¼šç™¼ç¥¨æ—¥æœŸ
                    
                    // === å‡ºè²¨èˆ‡å¸³å–®è³‡è¨Š (Ship To/Bill To) ===
                    "SHIP TO": data.buyer_address || "",             // å°æ‡‰ï¼šè²·æ–¹åœ°å€ (Ship To)
                    "SHIP TO ATTN": data.buyer_name || "",           // å°æ‡‰ï¼šè²·æ–¹åç¨± (æ”¶ä»¶äºº)
                    "BILL TO": data.buyer_address || "",             // æš«åŒ Ship To (è‹¥æœ‰å°ˆé–€æ¬„ä½éœ€èª¿æ•´)
                    
                    // === è²¡å‹™èˆ‡éŠ·å”®è³‡è¨Š ===
                    "CURRENCYY": "TWD",                              // é è¨­å°å¹£ (è«‹æ ¹æ“šç™¼ç¥¨å…§å®¹èª¿æ•´)
                    "PRICE BOOK": "",                                // ç•™ç©º
                    "SALES": data.sales_total || data.grand_total || "", // å°æ‡‰ï¼šéŠ·å”®é¡æˆ–ç¸½é‡‘é¡
                    "PAYMENT TERM": "",                              // ç•™ç©º
                    
                    // === ç³»çµ±èˆ‡ç‰©æµè³‡è¨Š ===
                    "WH": "MAIN",                                    // ç¯„ä¾‹ï¼šä¸»å€‰åº«
                    "LINE SET": "1",
                    "SHIPPING METHOD": "AIR",                        // ç¯„ä¾‹ï¼šç©ºé‹
                    "FOB": "",
                    "SHIPPING INSTRUCTIONS": "",
                    "CONVERSION TYPE": "STANDARD"
                })
            },
            'TWO_STAGE': {
                id: 'TWO_STAGE', name: 'å…©éšæ®µ', desc: 'å…©éšæ®µ.csv (æ‰¹æ¬¡è™•ç†)', icon: 'âš™ï¸', ext: 'csv',
                headers: [
                    "ç¾¤çµ„å", "From Org", "To Org", "å–®æ“šåˆ¥", "Transaction Type", 
                    "å°è±¡åˆ¥", "å°è±¡åˆ¥ç·¨è™Ÿ", "EndCustå°è±¡åˆ¥", "EndCustå°è±¡åˆ¥ç·¨è™Ÿ", 
                    "å…§orå¤–éŠ·", "ç•°å‹•åŸå› ", "Mawb", "Hawb", "é€²å£å ±å–®", 
                    "è¡¨é ­å‚™è¨»", "WFå„ªå…ˆåº", "Ship Via", "ç”³è«‹è€…å·¥è™Ÿ", "Line Num", 
                    "From Item", "From Subinvnetory", "To Subinventory", "Quantity", 
                    "Po Number", "Invoice Number", "Vendor RMA Num", "Credit Number", 
                    "è¡¨èº«å‚™è¨»", "ç‡’éŒ„å–®è™Ÿ", "Check Sum", "ç”¢åœ°", "Do No åŸå» ", "RMA No(Attribute1)"
                ],
                // è³‡æ–™å°æ‡‰é‚è¼¯
                mapFn: (data) => ({
                    // === æ ¸å¿ƒå–®æ“šè³‡è¨Š (èˆ‡ OCR å°æ‡‰) ===
                    "ç¾¤çµ„å": "OCR_INV_GROUP",                   // ç¯„ä¾‹ï¼šæ‰¹æ¬¡è™•ç†ç¾¤çµ„åç¨±
                    "å–®æ“šåˆ¥": "INV",                             // ç¯„ä¾‹ï¼šç™¼ç¥¨å–®æ“š
                    "Invoice Number": data.invoice_no || "",     // å°æ‡‰ï¼šç™¼ç¥¨è™Ÿç¢¼
                    "Quantity": data.quantity || "1",            // å°æ‡‰ï¼šæ•¸é‡
                    "Line Num": "1",                             // é è¨­ç¬¬ä¸€è¡Œ
                    "From Item": data.item_name || "",           // å°æ‡‰ï¼šå“å
                    
                    // === äº¤æ˜“å°è±¡è³‡è¨Š ===
                    "å°è±¡åˆ¥": "VENDOR",                          // é è¨­äº¤æ˜“å°è±¡ç‚ºä¾›æ‡‰å•†
                    "å°è±¡åˆ¥ç·¨è™Ÿ": data.seller_id || "",          // å°æ‡‰ï¼šè³£æ–¹çµ±ç·¨
                    
                    // === çµ„ç¹”èˆ‡äº¤æ˜“é¡å‹ (éœ€ä¾ç³»çµ±èª¿æ•´) ===
                    "From Org": "TW_WH",                         // ç¯„ä¾‹ï¼šä¾†æºçµ„ç¹”
                    "To Org": "TW_MFG",                          // ç¯„ä¾‹ï¼šç›®çš„çµ„ç¹”
                    "Transaction Type": "RECEIPT",               // ç¯„ä¾‹ï¼šæ”¶è²¨/å…¥åº«
                    
                    // === å‚™è¨»èˆ‡è¿½è¹¤è³‡è¨Š ===
                    "è¡¨é ­å‚™è¨»": `OCR Invoice Upload: ${data.invoice_no}`,
                    "è¡¨èº«å‚™è¨»": "",
                    
                    // === é è¨­æˆ–ç•™ç©ºæ¬„ä½ ===
                    "EndCustå°è±¡åˆ¥": "",
                    "EndCustå°è±¡åˆ¥ç·¨è™Ÿ": "",
                    "å…§orå¤–éŠ·": "å…§éŠ·",
                    "ç•°å‹•åŸå› ": "",
                    "Mawb": "",
                    "Hawb": "",
                    "é€²å£å ±å–®": "",
                    "WFå„ªå…ˆåº": "3",
                    "Ship Via": "",
                    "ç”³è«‹è€…å·¥è™Ÿ": "",
                    "From Subinvnetory": "STAGING",
                    "To Subinventory": "STORES",
                    "Po Number": "",
                    "Vendor RMA Num": "",
                    "Credit Number": "",
                    "ç‡’éŒ„å–®è™Ÿ": "",
                    "Check Sum": "",
                    "ç”¢åœ°": "",
                    "Do No åŸå» ": "",
                    "RMA No(Attribute1)": ""
                })
            }
        };

        // === é¡å‹å°ç…§è¡¨ï¼šæ±ºå®šå“ªäº›é¡å‹é¡¯ç¤ºå“ªäº›æ ¼å¼ ===
        const typeMapping = {
            'invoice': ['406', '407'],        // ç™¼ç¥¨ -> åªé¡¯ç¤º 406, 407
            'order': ['CO', 'SO', 'TWO_STAGE'] // è¨‚å–® -> é¡¯ç¤º CO, SO, å…©éšæ®µ
        };

        // === åˆå§‹åŒ–é‚è¼¯ ===
        window.addEventListener('DOMContentLoaded', () => {
            // 1. è®€å–è³‡æ–™
            const savedData = localStorage.getItem('shared_ocr_data');
            // 2. è®€å–é¡å‹ (é—œéµæ­¥é©Ÿ)
            const savedType = localStorage.getItem('selected_doc_type');
            
            if (savedType && typeMapping[savedType]) {
                docType = savedType;
                console.log("åµæ¸¬åˆ°æ–‡ä»¶é¡å‹:", docType);
            } else {
                console.log("ç„¡æ–‡ä»¶é¡å‹ï¼Œä½¿ç”¨é è¨­ (invoice)");
            }

            // æ›´æ–°æ¨™é¡Œ
            const typeName = docType === 'invoice' ? 'ç™¼ç¥¨' : 'è¨‚å–®';
            document.getElementById('formatTitle').textContent = `ç”±æ–¼æ‚¨é¸æ“‡äº†ã€${typeName}ã€‘ï¼Œè«‹é¸æ“‡å°æ‡‰çš„åŒ¯å‡ºæ ¼å¼ï¼š`;

            if (savedData) {
                try {
                    currentData = JSON.parse(savedData);
                    setText('sum_invoice_no', currentData.invoice_no);
                    setText('sum_invoice_date', currentData.invoice_date);
                    setText('sum_seller_id', currentData.seller_id);
                    setText('sum_grand_total', currentData.grand_total);
                } catch (e) { console.error(e); }
            }

            // 3. å‹•æ…‹ç”Ÿæˆæ ¼å¼å¡ç‰‡
            renderFormatCards();
        });

        function renderFormatCards() {
            const container = document.getElementById('formatContainer');
            container.innerHTML = ''; // æ¸…ç©º

            // å–å¾—è©²é¡å‹å…è¨±çš„æ ¼å¼ ID åˆ—è¡¨
            const allowedFormats = typeMapping[docType];

            allowedFormats.forEach(formatId => {
                const config = allFormats[formatId];
                if (!config) return;

                // å»ºç«‹å¡ç‰‡ HTML
                const card = document.createElement('div');
                card.className = 'format-card';
                card.onclick = () => selectFormat(formatId, card);
                
                card.innerHTML = `
                    <div class="check-mark">âœ“</div>
                    <div class="format-icon">${config.icon}</div>
                    <div class="format-name">${config.name}</div>
                    <div class="format-desc">${config.desc}</div>
                `;
                container.appendChild(card);
            });
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if(el) el.textContent = val || '-';
        }

        // === äº’å‹•é‚è¼¯ ===
        function selectFormat(formatKey, cardElement) {
            selectedFormat = formatKey;
            
            // UI æ›´æ–°
            document.querySelectorAll('.format-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');

            // æŒ‰éˆ•æ›´æ–°
            const config = allFormats[formatKey];
            const btn = document.getElementById('downloadBtn');
            btn.disabled = false;
            btn.textContent = `â¬‡ï¸ ä¸‹è¼‰ ${config.name}`;
        }

        function goBackToEdit() {
            window.location.href = 'invoice_OCR_result.html';
        }

        // === ä¸‹è¼‰é‚è¼¯ ===
        function generateAndDownload() {
            if (!selectedFormat) return;

            const config = allFormats[selectedFormat];
            
            // æº–å‚™è³‡æ–™
            const mappedRow = config.mapFn(currentData);
            const dataArray = [mappedRow];

            // å»ºç«‹ Excel/CSV ç‰©ä»¶
            const ws = XLSX.utils.json_to_sheet(dataArray, { header: config.headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ExportData");

            // æ±ºå®šæª”å
            const fileNo = currentData.invoice_no || 'Data';
            const prefix = config.desc.split(' ')[0].split('.')[0]; // æŠ“å–æª”åå‰ç¶´ (å¦‚ 406INF)
            const fileName = `${prefix}_${fileNo}.${config.ext}`;
            
            // è§¸ç™¼ä¸‹è¼‰
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>