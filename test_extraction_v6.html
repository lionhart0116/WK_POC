<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª OCR è¡¨æ ¼æå–å¤šæ¨¡å¼æ¸¬è©¦å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-test {
            background: #667eea;
            color: white;
        }
        
        .btn-test:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-clear {
            background: #f5f5f5;
            color: #666;
        }
        
        .btn-clear:hover {
            background: #e0e0e0;
        }
        
        .result {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .result-item.success {
            border-left-color: #4caf50;
        }
        
        .result-item.warning {
            border-left-color: #ff9800;
        }
        
        .result-item.error {
            border-left-color: #f44336;
        }
        
        .result-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-content {
            color: #666;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
        }
        
        .mode-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .mode-indicator.modeA {
            background: #c8e6c9;
            color: #1b5e20;
        }
        
        .mode-indicator.modeB {
            background: #fff9c4;
            color: #f57f17;
        }
        
        .mode-indicator.modeC {
            background: #ffccbc;
            color: #d84315;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 16px;
            border: none;
            background: none;
            cursor: pointer;
            color: #999;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª OCR è¡¨æ ¼æå–å¤šæ¨¡å¼æ¸¬è©¦å·¥å…·</h1>
            <p>é©—è­‰ v6 çš„ä¸‰å±¤å®¹éŒ¯æ©Ÿåˆ¶ï¼šæ¨™æº–æ¨¡å¼ â†’ å‚™ç”¨æ¨¡å¼ â†’ ç°¡åŒ–æ¨¡å¼</p>
        </div>
        
        <!-- æ¸¬è©¦ 1: æ¨™æº–ç™¼ç¥¨ (æ¨¡å¼ A) -->
        <div class="test-section">
            <div class="test-title">
                <span>ğŸ“‹ æ¸¬è©¦ 1: æ¨™æº–è‹±æ–‡ç™¼ç¥¨</span>
                <span class="badge">æ¨¡å¼ A</span>
            </div>
            
            <textarea id="input1" placeholder="è²¼ä¸Š fullText å…§å®¹...">Quantity Unit Price Amount(USD) PO.NO
1 9720 PCS
Item No. WL6WR1510
Description
WLGWR1510-DAIKIN
3.2208
31306.18
750190684
2 2124 PCS
WCT2GM2511
WCT2GM2511-TPV
2.3461
4983.12 750189359
3 2676 PCS
WCT2GM2511
WCT2GM2511-TPV
2.3461
6278.16
750190684
TOTAL 212825.81</textarea>
            
            <div class="button-group">
                <button class="btn-test" onclick="testMode('standard', 'input1', 'result1')">ğŸš€ æ¸¬è©¦æ¨™æº–æ¨¡å¼</button>
                <button class="btn-clear" onclick="clearTest('input1', 'result1')">æ¸…é™¤</button>
            </div>
            
            <div id="result1" class="result" style="display:none;"></div>
        </div>
        
        <!-- æ¸¬è©¦ 2: ä¸­æ–‡ç™¼ç¥¨ (æ¨¡å¼ B) -->
        <div class="test-section">
            <div class="test-title">
                <span>ğŸ“‹ æ¸¬è©¦ 2: ä¸­æ–‡æ›¿ä»£æ ¼å¼ç™¼ç¥¨</span>
                <span class="badge">æ¨¡å¼ B</span>
            </div>
            
            <textarea id="input2" placeholder="è²¼ä¸Š fullText å…§å®¹...">å“å                 æ•°é‡   å–®åƒ¹   é‡‘é¡      PO
1 ä¸»æ¿æ¨¡çµ„           100    500    50000    750180001
å‹è™Ÿ: MB-2021-A
æè¿°: é«˜ç«¯ä¸»æ¿çµ„ä»¶
2 é©…å‹•ç¨‹å¼           50     200    10000    750180002
å‹è™Ÿ: DV-2021-B
è»Ÿé«”åŒ…
åˆè®¡: 60000</textarea>
            
            <div class="button-group">
                <button class="btn-test" onclick="testMode('alternative', 'input2', 'result2')">ğŸš€ æ¸¬è©¦å‚™ç”¨æ¨¡å¼</button>
                <button class="btn-clear" onclick="clearTest('input2', 'result2')">æ¸…é™¤</button>
            </div>
            
            <div id="result2" class="result" style="display:none;"></div>
        </div>
        
        <!-- æ¸¬è©¦ 3: è‡ªè¨‚è¼¸å…¥ -->
        <div class="test-section">
            <div class="test-title">
                <span>ğŸ”§ æ¸¬è©¦ 3: è‡ªè¨‚è¼¸å…¥ (æ¸¬è©¦æ‚¨çš„ç™¼ç¥¨)</span>
                <span class="badge">å…¨æ¨¡å¼</span>
            </div>
            
            <textarea id="input3" placeholder="è²¼ä¸Šæ‚¨çš„ç™¼ç¥¨ fullText å…§å®¹..."></textarea>
            
            <div class="button-group">
                <button class="btn-test" onclick="testMode('auto', 'input3', 'result3')">ğŸš€ è‡ªå‹•æª¢æ¸¬æ¨¡å¼</button>
                <button class="btn-clear" onclick="clearTest('input3', 'result3')">æ¸…é™¤</button>
            </div>
            
            <div id="result3" class="result" style="display:none;"></div>
        </div>
    </div>
    
    <script>
        // è¤‡è£½ v6 çš„ä¸‰å€‹æå–å‡½æ•¸åˆ°æ¸¬è©¦ç’°å¢ƒ
        
        function extractInvoiceTableItemsStandard(fullText) {
            console.log('[TEST] åŸ·è¡Œæ¨™æº–æ¨¡å¼...');
            const items = [];
            const tableStart = fullText.toUpperCase().indexOf('QUANTITY');
            const tableEnd = fullText.toUpperCase().indexOf('TOTAL');
            
            if (tableStart === -1 || tableEnd === -1) {
                console.log('[TEST] æ¨™æº–æ¨¡å¼å¤±æ•—: tableStart=' + tableStart + ', tableEnd=' + tableEnd);
                return null;
            }
            
            const tableContent = fullText.substring(tableStart, tableEnd);
            const tableLines = tableContent.split('\n').filter(l => l.trim().length > 0);
            
            let i = 1;
            while (i < tableLines.length) {
                const line = tableLines[i].trim();
                const lineNoMatch = line.match(/^(\d{1,2})\s+(.+)/);
                if (!lineNoMatch) {
                    i++;
                    continue;
                }
                
                const lineNo = lineNoMatch[1];
                const lineRest = lineNoMatch[2];
                
                const item = {
                    lineNo,
                    quantity: null,
                    unit: null,
                    itemNo: null,
                    description: null,
                    unitPrice: null,
                    amount: null,
                    poNo: null
                };
                
                const qtyMatch = lineRest.match(/(\d+)\s+(PCS|EA|BOX|CASE|KG|M|PACK|UNITS?|SET|LOT|ROLL)/i);
                if (qtyMatch) {
                    item.quantity = parseInt(qtyMatch[1]);
                    item.unit = qtyMatch[2].toUpperCase();
                }
                
                let j = i + 1;
                const itemLines = [];
                
                while (j < tableLines.length) {
                    const nextLine = tableLines[j].trim();
                    if (/^\d{1,2}\s+/.test(nextLine)) {
                        break;
                    }
                    
                    const upperLine = nextLine.toUpperCase();
                    if (/^(ITEM NO|DESCRIPTION|UNIT PRICE|AMOUNT|PO\.?NO|QTY|QUANTITY)/.test(upperLine)) {
                        j++;
                        continue;
                    }
                    
                    itemLines.push(nextLine);
                    j++;
                }
                
                let textFieldCount = 0;
                for (const iline of itemLines) {
                    const trimmed = iline.trim();
                    const isNumeric = /^[\d,\.]+$/.test(trimmed);
                    
                    if (isNumeric) {
                        const num = parseFloat(trimmed.replace(/,/g, ''));
                        if (/^\d{9}$/.test(trimmed.replace(/,/g, ''))) {
                            item.poNo = trimmed.replace(/,/g, '');
                        } else if (num < 1000 && num > 0.1 && !item.unitPrice) {
                            item.unitPrice = num;
                        } else if (num >= 1000 && num < 1000000 && !item.amount) {
                            item.amount = num;
                        }
                    } else if (trimmed.match(/^[A-Z0-9]/i)) {
                        if (textFieldCount === 0) {
                            item.itemNo = trimmed;
                            textFieldCount++;
                        } else if (textFieldCount === 1 && !item.description) {
                            item.description = trimmed;
                            textFieldCount++;
                        }
                    }
                }
                
                if (!item.amount && item.quantity && item.unitPrice) {
                    item.amount = parseFloat((item.quantity * item.unitPrice).toFixed(2));
                }
                
                items.push(item);
                i = j;
            }
            
            console.log('[TEST] æ¨™æº–æ¨¡å¼æˆåŠŸæå– ' + items.length + ' é …');
            return items.length > 0 ? items : null;
        }
        
        function extractInvoiceTableItemsAlternative(fullText) {
            console.log('[TEST] åŸ·è¡Œå‚™ç”¨æ¨¡å¼...');
            const upperText = fullText.toUpperCase();
            const items = [];
            
            const startMarkers = ['QUANTITY', 'æ•°é‡', 'å“å', 'ITEMS', 'SKU', 'PART NUMBER'];
            const endMarkers = ['TOTAL', 'åˆè®¡', 'å°è®¡', 'SUBTOTAL', 'GRAND TOTAL', 'AMOUNT DUE'];
            
            let tableStart = -1;
            let tableEnd = -1;
            
            for (const marker of startMarkers) {
                tableStart = upperText.indexOf(marker.toUpperCase());
                if (tableStart !== -1) {
                    console.log('[TEST] æ‰¾åˆ°èµ·å§‹æ¨™è¨˜: ' + marker);
                    break;
                }
            }
            
            for (const marker of endMarkers) {
                tableEnd = upperText.indexOf(marker.toUpperCase());
                if (tableEnd !== -1) {
                    console.log('[TEST] æ‰¾åˆ°çµæŸæ¨™è¨˜: ' + marker);
                    break;
                }
            }
            
            if (tableStart === -1 || tableEnd === -1) {
                console.log('[TEST] å‚™ç”¨æ¨¡å¼å¤±æ•—: tableStart=' + tableStart + ', tableEnd=' + tableEnd);
                return null;
            }
            
            const tableContent = fullText.substring(tableStart, tableEnd);
            const tableLines = tableContent.split('\n').filter(l => l.trim().length > 0);
            
            let i = 1;
            while (i < tableLines.length) {
                const line = tableLines[i].trim();
                const lineNoMatch = line.match(/^([0-9A-Z]{1,3})\s+(.+)/);
                if (!lineNoMatch) {
                    i++;
                    continue;
                }
                
                const lineNo = lineNoMatch[1];
                const lineRest = lineNoMatch[2];
                
                const item = {
                    lineNo,
                    quantity: null,
                    unit: null,
                    itemNo: null,
                    description: null,
                    unitPrice: null,
                    amount: null,
                    poNo: null
                };
                
                const qtyMatch = lineRest.match(/(\d+)\s+(PCS|EA|BOX|CASE|KG|M|PACK|UNITS?|SET|LOT|ROLL|ä»¶|å¥—|å·|å¼µ)/i);
                if (qtyMatch) {
                    item.quantity = parseInt(qtyMatch[1]);
                    item.unit = qtyMatch[2];
                }
                
                let j = i + 1;
                const itemLines = [];
                
                while (j < tableLines.length && !/^([0-9A-Z]{1,3})\s+/.test(tableLines[j].trim())) {
                    itemLines.push(tableLines[j].trim());
                    j++;
                }
                
                let textFieldCount = 0;
                for (const iline of itemLines) {
                    const trimmed = iline.trim();
                    const isNumeric = /^[\d,\.]+$/.test(trimmed);
                    
                    if (isNumeric) {
                        const num = parseFloat(trimmed.replace(/,/g, ''));
                        if (num < 1000 && num > 0.1 && !item.unitPrice) {
                            item.unitPrice = num;
                        } else if (num >= 1000 && num < 10000000 && !item.amount) {
                            item.amount = num;
                        }
                    } else if (trimmed.length > 0) {
                        if (textFieldCount === 0) {
                            item.itemNo = trimmed;
                            textFieldCount++;
                        } else if (textFieldCount === 1) {
                            item.description = trimmed;
                            textFieldCount++;
                        }
                    }
                }
                
                if (!item.amount && item.quantity && item.unitPrice) {
                    item.amount = parseFloat((item.quantity * item.unitPrice).toFixed(2));
                }
                
                items.push(item);
                i = j;
            }
            
            console.log('[TEST] å‚™ç”¨æ¨¡å¼æˆåŠŸæå– ' + items.length + ' é …');
            return items.length > 0 ? items : null;
        }
        
        function testMode(mode, inputId, resultId) {
            const input = document.getElementById(inputId);
            const result = document.getElementById(resultId);
            const fullText = input.value.trim();
            
            if (!fullText) {
                showResult(resultId, 'error', 'âŒ éŒ¯èª¤', 'è«‹è¼¸å…¥ fullText å…§å®¹');
                return;
            }
            
            let items = null;
            let detectedMode = 'æœªçŸ¥';
            
            if (mode === 'standard') {
                items = extractInvoiceTableItemsStandard(fullText);
                detectedMode = 'æ¨™æº–æ¨¡å¼';
            } else if (mode === 'alternative') {
                items = extractInvoiceTableItemsAlternative(fullText);
                detectedMode = 'å‚™ç”¨æ¨¡å¼';
            } else if (mode === 'auto') {
                // è‡ªå‹•æ¸¬è©¦ä¸‰å€‹æ¨¡å¼
                items = extractInvoiceTableItemsStandard(fullText);
                if (items) {
                    detectedMode = 'âœ… æ¨™æº–æ¨¡å¼æˆåŠŸ';
                } else {
                    items = extractInvoiceTableItemsAlternative(fullText);
                    if (items) {
                        detectedMode = 'âœ… å‚™ç”¨æ¨¡å¼æˆåŠŸ';
                    } else {
                        detectedMode = 'âŒ æ‰€æœ‰æ¨¡å¼éƒ½å¤±æ•—';
                    }
                }
            }
            
            result.style.display = 'block';
            
            if (!items) {
                showResult(resultId, 'error', 'âŒ æå–å¤±æ•—', detectedMode);
                return;
            }
            
            // é¡¯ç¤ºçµæœ
            let html = `<div class="result-item success">
                <div class="result-header">âœ… æå–æˆåŠŸ (${detectedMode})</div>
                <div class="result-content">å…±æå– ${items.length} é …</div>
            </div>`;
            
            items.forEach((item, idx) => {
                html += `<div class="result-item">
                    <div class="result-header">ğŸ“Œ Item #${item.lineNo}</div>
                    <div class="result-content">
Qty: ${item.quantity} ${item.unit}
ItemNo: ${item.itemNo || '(ç©º)'}
Description: ${item.description || '(ç©º)'}
UnitPrice: $${item.unitPrice || '(ç©º)'}
Amount: $${item.amount || '(ç©º)'}
PO: ${item.poNo || '(ç©º)'}
                    </div>
                </div>`;
            });
            
            result.innerHTML = html;
        }
        
        function showResult(resultId, type, header, content) {
            const result = document.getElementById(resultId);
            result.style.display = 'block';
            result.innerHTML = `<div class="result-item ${type}">
                <div class="result-header">${header}</div>
                <div class="result-content">${content}</div>
            </div>`;
        }
        
        function clearTest(inputId, resultId) {
            document.getElementById(inputId).value = '';
            document.getElementById(resultId).style.display = 'none';
            document.getElementById(resultId).innerHTML = '';
        }
    </script>
</body>
</html>
